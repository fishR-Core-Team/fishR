{
  "hash": "a15455307ff963d3ed7fffb31dab2120",
  "result": {
    "markdown": "---\ntitle: Adding Zero Catches\ndescription: Add zeroes for species not caught so that CPE calculations are correct\nauthor: Derek H. Ogle\ndate: 4/19/2018\nimage: ../../../helpers/explanation.png\ncategories:\n  - \" Explanation\"\n  - Data Wrangling\n  - CPE\n---\n\n\n:::{.callout-note}\nThe following packages are loaded for use below. I also set the random number seed for reproducibility of the randomly generated sample data below.\n:::\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(dplyr)    # for group_by(), summarize(), mutate(), right_join()\nlibrary(tidyr)    # for complete(), nesting()\nset.seed(678394)  # for reproducibility of randomly created data\n```\n:::\n\n\n&nbsp;\n\n# Introduction\nMuch of my work is with undergraduates who are first learning to analyze fisheries data. A common \"learning opportunity\" occurs when students are asked to compute the mean catch (or CPE), along with a standard deviation (SD), across multiple gear sets for each species. The learning opportunity occurs because some species will invariably not be caught in some gear sets. When the students summarize the number of fish caught for each species in each gear set those species not caught in a particular gear set will not \"appear\" in their data. Thus, when calculating the mean, the student will get the correct numerator (sum of catch across all gear sets) but not denominator (they use number of catches summed rather than total number of gear sets), which inflates (over-estimates) the mean catch and (usually) deflates (under-estimates) the SD of catches. Once confronted with this issue, they easily realize how to correct the mean calculation, but calculating the standard deviation is still an issue. These problems are exacerbated when using software to compute these summary statistics across many individual gear sets.\n\nIn software, the \"trick\" is to add a zero for each species not caught in a specific gear set that was caught in at least one gear set. For example, if Bluegill were caught in at least one gear set but not in the third gear set, then a zero must be added as the catch of Bluegill in the third gear set. The `addZeroCatch()` function in the `FSA` package was an attempt to efficiently add these zeroes. This function has proven useful over the years, but I have become dissatisfied with its clunkiness. Additionally, I recently became aware of the `complete()` function in the `tidyr` package which holds promise for handling the same task. In this post, I explore the use of `complete()` for handling this issue.\n\n&nbsp;\n\n# Simple Data\nIn this first example, the data consists of `species` and `length` recorded for each captured fish organized by the gear set identification number (`ID`) and held in the `fishdat` data.frame.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    ID species  tl\n#R|  1  1     BLG 148\n#R|  2  1     BLG 153\n#R|  3  1     BLG 147\n#R|  4  1     BLG 149\n#R|  5  1     BLG 144\n#R|  6  1     BLG 145\n```\n:::\n:::\n\n\nThe catch of each species in each gear set may be found using `group_by()` and `summarize()` with `n()`.^[ I find the `tibble` structure returned by `group_by()` to be annoying with simple data frames like this. Thus, I usually use `as.data.frame()` to remove it.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch <- fishdat |>\n  group_by(ID,species) |>\n  summarize(num=n()) |>\n  as.data.frame()\ncatch\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID species num\n#R|  1   1     BLG  10\n#R|  2   1     LMB   5\n#R|  3   1     YEP   5\n#R|  4   2     LMB   9\n#R|  5   2     YEP   7\n#R|  6   3     BLG  12\n#R|  7   3     YEP   7\n#R|  8   4     BLG   1\n#R|  9   4     LMB  11\n#R|  10  4     YEP  11\n#R|  11  5     BLG   9\n```\n:::\n:::\n\n\nFrom this it is seen that three species (\"BLG\", \"LMB\", and \"YEP\") were captured across all nets, but that \"BLG\" were not captured in \"ID=2\", \"LMB\" were not captured in \"ID=3\", and \"LMB\" and \"YEP\" were not captured in \"ID=5\". The sample size, mean, and SD of catches per species from these data may be found by again using `group_by()` and `summarize()`. However, these calculations are **INCORRECT** because they do not include the zero catches of \"BLG\" in \"ID=2\", \"LMB\" in \"ID=3\", and \"LMB\" and \"YEP\" in \"ID=5\". The problem is most evident in the sample sizes, which should be five (gear sets) for each species.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Example of INCORRECT summaries because not using zeroes\ncatch |> \n  group_by(species) |>\n  summarize(n=n(),mn=mean(num),sd=sd(num)) |>\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    species n       mn       sd\n#R|  1     BLG 4 8.000000 4.830459\n#R|  2     LMB 3 8.333333 3.055050\n#R|  3     YEP 4 7.500000 2.516611\n```\n:::\n:::\n\n\nThe `complete()` function can be used to add rows to a data frame for variables (or combinations of variables) that should be present in the data frame (relative to other values that are present) but are not. The `complete()` function takes a data frame as its first argument (but will be \"piped\" in below with `|>`) and the variable or variables that will be used to identify which items are missing. For example, with these data, a zero should be added to `num` for missing combinations defined by `ID` and `species`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Example of default complete ... see below to add zeroes, not NAs\ncatch |>\n  complete(ID,species) |>\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID species num\n#R|  1   1     BLG  10\n#R|  2   1     LMB   5\n#R|  3   1     YEP   5\n#R|  4   2     BLG  NA\n#R|  5   2     LMB   9\n#R|  6   2     YEP   7\n#R|  7   3     BLG  12\n#R|  8   3     LMB  NA\n#R|  9   3     YEP   7\n#R|  10  4     BLG   1\n#R|  11  4     LMB  11\n#R|  12  4     YEP  11\n#R|  13  5     BLG   9\n#R|  14  5     LMB  NA\n#R|  15  5     YEP  NA\n```\n:::\n:::\n\n\nFrom this result, it is seen that `complete()` added a row for \"BLG\" in \"ID=2\", \"LMB\" in \"ID=3\", and \"LMB\" and \"YEP\" in \"ID=5\" as we had hoped. However, `complete()` adds `NA`s by default. The value to add can be changed with `fill=`, which takes a list that includes the name of the variable to which the `NA`s were added (`num` in this case) set equal to the value to be added (`0` in this case).^[Here the result is saved into the `catch` data frame, thus modifying the original data frame with the addition of the zeroes.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch <- catch |>\n  complete(ID,species,fill=list(num=0)) |>\n  as.data.frame()\ncatch\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID species num\n#R|  1   1     BLG  10\n#R|  2   1     LMB   5\n#R|  3   1     YEP   5\n#R|  4   2     BLG   0\n#R|  5   2     LMB   9\n#R|  6   2     YEP   7\n#R|  7   3     BLG  12\n#R|  8   3     LMB   0\n#R|  9   3     YEP   7\n#R|  10  4     BLG   1\n#R|  11  4     LMB  11\n#R|  12  4     YEP  11\n#R|  13  5     BLG   9\n#R|  14  5     LMB   0\n#R|  15  5     YEP   0\n```\n:::\n:::\n\n\nThese correct catch data can then be summarized as above to show the correct sample size, mean, and SD of catches per species.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch |>\n  group_by(species) |>\n  summarize(n=n(),mn=mean(num),sd=sd(num)) |>\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    species n  mn       sd\n#R|  1     BLG 5 6.4 5.504544\n#R|  2     LMB 5 5.0 5.049752\n#R|  3     YEP 5 6.0 4.000000\n```\n:::\n:::\n\n\n&nbsp;\n\n# Multiple Values to Receive Zeroes\nSuppose that the fish data included a column that indicates whether the fish was marked and returned to the waterbody or not.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    ID species  tl marked\n#R|  1  1     BLG 148    YES\n#R|  2  1     BLG 153    YES\n#R|  3  1     BLG 147    YES\n#R|  4  1     BLG 149    YES\n#R|  5  1     BLG 144    YES\n#R|  6  1     BLG 145    YES\n```\n:::\n:::\n\n\nThe catch and number of fish marked and returned per gear set ID and species may again be computed with `group_by()` and `summarize()`. Note, however, the use of `ifelse()` to use a `1` if the fish was marked and a `0` if it was not. Summing these values returns the number of fish that were marked. Giving this data frame to `complete()` as before will add zeroes for both the `num` and `nmarked` variables as long as both are included in the list given to `fill=`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch2 <- fishdat2 |>\n  group_by(ID,species) |>\n  summarize(num=n(),\n            nmarked=sum(ifelse(marked==\"YES\",1,0)))\ncatch2\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 11 Ã— 4\n#R|  # Groups:   ID [5]\n#R|        ID species   num nmarked\n#R|     <dbl> <chr>   <int>   <dbl>\n#R|   1     1 BLG        10       8\n#R|   2     1 LMB         5       2\n#R|   3     1 YEP         5       2\n#R|   4     2 LMB         9       5\n#R|   5     2 YEP         7       2\n#R|   6     3 BLG        12       3\n#R|   7     3 YEP         7       4\n#R|   8     4 BLG         1       0\n#R|   9     4 LMB        11       4\n#R|  10     4 YEP        11       7\n#R|  11     5 BLG         9       6\n```\n:::\n:::\n\n\nThere are two things to note in this output. First, that there are no zeroes for `num` and `nmarked` for the same species and gear sets as before. Second, the summarization was across two groups but `summarize()` only removes one of the `group_by()` variables. Thus, this result is still grouped by `ID` as shown above, which will interfere with using `complete()` to add the zeroes. This grouping can be removed with `ungroup()` as shown below before using `complete()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch2 <- catch2 |>\n  ungroup() |>\n  complete(ID,species,fill=list(num=0,nmarked=0)) |>\n  as.data.frame()\ncatch2\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID species num nmarked\n#R|  1   1     BLG  10       8\n#R|  2   1     LMB   5       2\n#R|  3   1     YEP   5       2\n#R|  4   2     BLG   0       0\n#R|  5   2     LMB   9       5\n#R|  6   2     YEP   7       2\n#R|  7   3     BLG  12       3\n#R|  8   3     LMB   0       0\n#R|  9   3     YEP   7       4\n#R|  10  4     BLG   1       0\n#R|  11  4     LMB  11       4\n#R|  12  4     YEP  11       7\n#R|  13  5     BLG   9       6\n#R|  14  5     LMB   0       0\n#R|  15  5     YEP   0       0\n```\n:::\n:::\n\n\n&nbsp;\n\n# More Information that Does Not Get Zeroes\n\nSuppose there is a data frame called `geardat` that contains information specific to each gear set.\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ngeardat\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    ID mon year  lake run effort\n#R|  1  1 May 2018 round   1   1.34\n#R|  2  2 May 2018 round   2   1.87\n#R|  3  3 May 2018 round   3   1.56\n#R|  4  4 May 2018  twin   1   0.92\n#R|  5  5 May 2018  twin   2   0.67\n```\n:::\n:::\n\n\nAnd, for the purposes of this example, suppose that we have summarized catch data WITHOUT the zeroes having been added.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch3 <- fishdat2 |>\n  group_by(ID,species) |>\n  summarize(num=n(),\n            nmarked=sum(ifelse(marked==\"YES\",1,0))) |>\n  as.data.frame()\ncatch3\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID species num nmarked\n#R|  1   1     BLG  10       8\n#R|  2   1     LMB   5       2\n#R|  3   1     YEP   5       2\n#R|  4   2     LMB   9       5\n#R|  5   2     YEP   7       2\n#R|  6   3     BLG  12       3\n#R|  7   3     YEP   7       4\n#R|  8   4     BLG   1       0\n#R|  9   4     LMB  11       4\n#R|  10  4     YEP  11       7\n#R|  11  5     BLG   9       6\n```\n:::\n:::\n\n\nFinally, suppose that these summarized catch data are joined with the gear data such that the gear set specific information is shown with each catch.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch3 <- right_join(geardat,catch3,by=\"ID\")\ncatch3\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID mon year  lake run effort species num nmarked\n#R|  1   1 May 2018 round   1   1.34     BLG  10       8\n#R|  2   1 May 2018 round   1   1.34     LMB   5       2\n#R|  3   1 May 2018 round   1   1.34     YEP   5       2\n#R|  4   2 May 2018 round   2   1.87     LMB   9       5\n#R|  5   2 May 2018 round   2   1.87     YEP   7       2\n#R|  6   3 May 2018 round   3   1.56     BLG  12       3\n#R|  7   3 May 2018 round   3   1.56     YEP   7       4\n#R|  8   4 May 2018  twin   1   0.92     BLG   1       0\n#R|  9   4 May 2018  twin   1   0.92     LMB  11       4\n#R|  10  4 May 2018  twin   1   0.92     YEP  11       7\n#R|  11  5 May 2018  twin   2   0.67     BLG   9       6\n```\n:::\n:::\n\n\nThese data simulate what might be seen from a flat database.\n\nWith these data, zeroes still need to be added as defined by missing combinations of `ID` and `species`. However, if only these two variables are included in `complete()` then zeroes will be added for `mon`, `year`, `lake`, `run`, and `effort`, which is not desired. These five variables are connected to or \"nested\" with the `ID` variable (i.e., if you know `ID` then you know the values of these other variables) and should be treated as a group. Nesting of variables can be handled in `complete()` by including the names of all the connected variables in `nesting()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch3 |> complete(nesting(ID,mon,year,lake,run,effort),species,\n                    fill=list(num=0,nmarked=0)) |>\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID mon year  lake run effort species num nmarked\n#R|  1   1 May 2018 round   1   1.34     BLG  10       8\n#R|  2   1 May 2018 round   1   1.34     LMB   5       2\n#R|  3   1 May 2018 round   1   1.34     YEP   5       2\n#R|  4   2 May 2018 round   2   1.87     BLG   0       0\n#R|  5   2 May 2018 round   2   1.87     LMB   9       5\n#R|  6   2 May 2018 round   2   1.87     YEP   7       2\n#R|  7   3 May 2018 round   3   1.56     BLG  12       3\n#R|  8   3 May 2018 round   3   1.56     LMB   0       0\n#R|  9   3 May 2018 round   3   1.56     YEP   7       4\n#R|  10  4 May 2018  twin   1   0.92     BLG   1       0\n#R|  11  4 May 2018  twin   1   0.92     LMB  11       4\n#R|  12  4 May 2018  twin   1   0.92     YEP  11       7\n#R|  13  5 May 2018  twin   2   0.67     BLG   9       6\n#R|  14  5 May 2018  twin   2   0.67     LMB   0       0\n#R|  15  5 May 2018  twin   2   0.67     YEP   0       0\n```\n:::\n:::\n\n\nIt is possible to have nesting with `species` as well. Suppose, for example, that the scientific name for the species was included in the original `fishdata2` that was summarized (using a combination of the examples from above, but not shown here) to `catch4`.\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch4\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID species                spsci num nmarked mon year  lake run effort\n#R|  1   1     BLG  Lepomis macrochirus  10       8 May 2018 round   1   1.34\n#R|  2   1     LMB Micropterus dolomieu   5       2 May 2018 round   1   1.34\n#R|  3   1     YEP     Perca flavescens   5       2 May 2018 round   1   1.34\n#R|  4   2     LMB Micropterus dolomieu   9       5 May 2018 round   2   1.87\n#R|  5   2     YEP     Perca flavescens   7       2 May 2018 round   2   1.87\n#R|  6   3     BLG  Lepomis macrochirus  12       3 May 2018 round   3   1.56\n#R|  7   3     YEP     Perca flavescens   7       4 May 2018 round   3   1.56\n#R|  8   4     BLG  Lepomis macrochirus   1       0 May 2018  twin   1   0.92\n#R|  9   4     LMB Micropterus dolomieu  11       4 May 2018  twin   1   0.92\n#R|  10  4     YEP     Perca flavescens  11       7 May 2018  twin   1   0.92\n#R|  11  5     BLG  Lepomis macrochirus   9       6 May 2018  twin   2   0.67\n```\n:::\n:::\n\n\nThe zeroes are then added to this data.frame making sure to note the nesting of `species` and `spsci`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ncatch4 |> \n  complete(nesting(ID,mon,year,lake,run,effort),\n           nesting(species,spsci),\n           fill=list(num=0,nmarked=0)) |>\n  as.data.frame()\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     ID mon year  lake run effort species                spsci num nmarked\n#R|  1   1 May 2018 round   1   1.34     BLG  Lepomis macrochirus  10       8\n#R|  2   1 May 2018 round   1   1.34     LMB Micropterus dolomieu   5       2\n#R|  3   1 May 2018 round   1   1.34     YEP     Perca flavescens   5       2\n#R|  4   2 May 2018 round   2   1.87     BLG  Lepomis macrochirus   0       0\n#R|  5   2 May 2018 round   2   1.87     LMB Micropterus dolomieu   9       5\n#R|  6   2 May 2018 round   2   1.87     YEP     Perca flavescens   7       2\n#R|  7   3 May 2018 round   3   1.56     BLG  Lepomis macrochirus  12       3\n#R|  8   3 May 2018 round   3   1.56     LMB Micropterus dolomieu   0       0\n#R|  9   3 May 2018 round   3   1.56     YEP     Perca flavescens   7       4\n#R|  10  4 May 2018  twin   1   0.92     BLG  Lepomis macrochirus   1       0\n#R|  11  4 May 2018  twin   1   0.92     LMB Micropterus dolomieu  11       4\n#R|  12  4 May 2018  twin   1   0.92     YEP     Perca flavescens  11       7\n#R|  13  5 May 2018  twin   2   0.67     BLG  Lepomis macrochirus   9       6\n#R|  14  5 May 2018  twin   2   0.67     LMB Micropterus dolomieu   0       0\n#R|  15  5 May 2018  twin   2   0.67     YEP     Perca flavescens   0       0\n```\n:::\n:::\n\n\n&nbsp;\n\n# Final Thoughts\nThis is my first exploration with `complete()` and it looks promising for this task of adding zeroes to data frames of catch by gear set for gear sets in which a species was not caught. I will be curious to hear what others think of this function and how it might fit in their workflow.\n\n&nbsp;\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}