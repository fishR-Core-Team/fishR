{
  "hash": "2df65078540836da066e757949cac6b5",
  "result": {
    "markdown": "---\ntitle: McCarrick et al. (2022) Back-Calculated TL Plots\ndescription: Using ggplot2 to recreate the boxplot and bar chart of back-calculated lengths at age in McCarrick et al. (2022).\nauthor: Derek H. Ogle\ndate: 3/28/2023\nimage: preview.png\ncategories:\n  - ggplot2\n  - box plot\n  - bar chart\n  - facets\n  - Data Wrangling\n  - Growth\n  - Back-calculation\n---\n\n\n:::{.callout-important}\n## Series Note\nThis is the fifth, and last, of several posts related to @mccarricketal_2022. I thank the authors for making their data available with their publication.\n:::\n\n# Introduction\n@mccarricketal_2022 examined the population dynamics of Yellowstone Cutthroat Trout (*Oncorhynchus clarkii bouvieri*) in Henrys Lake, Idaho over a nearly two decade period. Their [Figure 6](https://meridian.allenpress.com/view-large/figure/14538511/i1944-687X-13-1-169-f06.tif) showed the back-calculated total length of both Cutthroat Trout at three ages separated by decade and their [Figure 7](https://meridian.allenpress.com/view-large/figure/14538512/i1944-687X-13-1-169-f07.tif) showed the mean (and SE) back-calculated TL at age for two time periods. I use `ggplot2` here to recreate both figures.\n\nThe following packages are loaded for use below. A few functions from each of `readxl`, `FSA`, `scales`, and `lemon` are used with `::` such that the entire packages are not attached here.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # for dplyr, ggplot2 packages\n```\n:::\n\n\n:::{.callout-note}\nYou will see below that I could recreate the structure but not the exact results of the author's Figure 6 or Figure 7. This may be due to issues present in the data provided with the publication that I discuss below, but it could also be that my data wrangling differs from theirs. I defer to the authors here as they are the experts with their data; I am just an interloper. I actually appreciate these data issues from an educational perspective as they provide rich opportunities to demonstrate a variety of techniques with \"real\" \"messy\" data.\n:::\n\n&nbsp;\n\n# Data Wrangling\n### Reading Excel File and Handling Some Initial Issuees\n@mccarricketal_2022 provided raw data for these figures as an Excel file in their Data Supplement S2. An initial glance at the Excel file revealed that every other line in the file was essentially a header line for the annular measurements on the scales or otoliths.^[This was not immediately obvious in the Excel file as a filter had been applied to hide those rows. I had to remove the filter in Excel to see the issue.] Fortunately, when these data were read in below, those lines appeared as missing data for the age-at-capture variable (as well as several others). Thus, I immediately removed rows with missing values in the age-at-capture variable. The variable names in Excel were also longer than I prefer so I renamed the variables that I chose to retain.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat <- readxl::read_excel(\"Download.xlsx\") |>\n  select(Year,ID=Fish_Number,Structure,capAge=Age_at_Capture,capTL=Total_Length_mm,\n         edge,starts_with(\"annulus\")) |>\n  filter(!is.na(capAge))\n\nFSA::headtail(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|       Year   ID Structure capAge capTL edge annulus1 annulus2 annulus3 annulus4\n#R|  1    2020  143   Otolith      3   402  982      464      754      982       NA\n#R|  2    2020  122   Otolith      2   266  692      428      692       NA       NA\n#R|  3    2020 1599   Otolith      2   452  994      702      994       NA       NA\n#R|  3257 1987   NA     Scale      2   240  435      155      352       NA       NA\n#R|  3258 1987   NA     Scale      3   305  531      137      331      431       NA\n#R|  3259 1987   NA     Scale      3   453  695      145      338      537       NA\n#R|       annulus5 annulus6 annulus7 annulus8 annulus9 annulus10 annulus11\n#R|  1          NA       NA       NA       NA       NA        NA        NA\n#R|  2          NA       NA       NA       NA       NA        NA        NA\n#R|  3          NA       NA       NA       NA       NA        NA        NA\n#R|  3257       NA       NA       NA       NA       NA        NA        NA\n#R|  3258       NA       NA       NA       NA       NA        NA        NA\n#R|  3259       NA       NA       NA       NA       NA        NA        NA\n```\n:::\n:::\n\n\nThese data are in what I call \"one-fish-per-line\" format. This is the \"tidy\" format for performing analyses on a fish, but it is not in a \"tidy\" format for performing analyses on lengths at specific ages. This will become more evident in the following sections.\n\nFor consideration below, note that `Structure` contains only `Scale` and `Otolith`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nunique(dat$Structure)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  [1] \"Otolith\" \"Scale\"\n```\n:::\n:::\n\n\n### Back-Calculation\nThe authors used the Dahl-Lea method of back-calculation for otoliths and the Fraser-Lee method for scales.^[I assume the reader is familiar with back-calculation methods. If not [see here](https://fishr-core-team.github.io/RFishBC/articles/BCIntro.html) or examine the methods in @mccarricketal_2022.] The length adjustment term in the Fraser-Lee method came from the intercept of the regression of length-at-capture on scale radius-at-capture. This regression is performed using the \"per fish\" data in `dat`, but filtered to only the data from scales. The intercept is extracted from the regression results and stored in `a` for use below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nLonR <- lm(capTL~edge,data=filter(dat,Structure==\"Scale\"))\n( a <- coef(LonR)[[\"(Intercept)\"]] )\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  [1] 54.99758\n```\n:::\n:::\n\n\nBack-calculating length at a previous age requires the data to be in a \"one-annulus-per-line\" format. For this purpose, the data in `dat` is considered \"wide\" (annuli are in multiple columns of each row) and need  to be \"pivoted\" to \"long\" format with `pivot_longer()`. The columns that contain the annular measurements are given to `cols=`, `values_to=` gets a name for the column to contain these annular measurements, and `names_to=` gets a name for the column to contain the \"label\" for the annular measurements. The new `bcAge` variable (from `names_to=`) will contain the old columns names (i.e., \"annulus 1\", \"annulus 2\", etc.) by default. `names_prefix=` is used below to remove \"annulus\" from these labels and leave just the numeric age *labels* (e.g., \"1\", \"2\", etc.). The age \"labels\" are converted to numeric values with `as.numeric()` in `mutate()`. Finally, many rows in the new `Radius` variable will be missing because annular measurements were not made for ages older than the age-at-capture for the fish (e.g., `Radius` will be missing for all ages greater than 3 for an age-3 fish). These rows are removed with `filter()` below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 <- dat |>\n  pivot_longer(cols=annulus1:annulus11,values_to=\"Radius\",\n               names_to=\"bcAge\",names_prefix=\"annulus\") |>\n  mutate(bcAge=as.numeric(bcAge)) |>\n  filter(!is.na(Radius))\n\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|       Year  ID Structure capAge capTL edge bcAge Radius\n#R|  1    2020 143   Otolith      3   402  982     1    464\n#R|  2    2020 143   Otolith      3   402  982     2    754\n#R|  3    2020 143   Otolith      3   402  982     3    982\n#R|  8754 1987  NA     Scale      3   453  695     1    145\n#R|  8755 1987  NA     Scale      3   453  695     2    338\n#R|  8756 1987  NA     Scale      3   453  695     3    537\n```\n:::\n:::\n\n\nThis data frame is now prepared to back-calculate lengths at previous ages from the measurements in `Radius`, the structure size-at-capture in `edge`, and the fish's length at capture in `capTL`. This calculation is somewhat complicated by the fact that different back-calculation equations are used depending on the structure examined. This is handled below using `case_when()` within `mutate()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 <- dat2 |>\n  mutate(bcTL=case_when(\n    Structure==\"Scale\" ~ ((capTL-a)/edge)*Radius+a,\n    Structure==\"Otolith\" ~ capTL*Radius/edge\n  ))\n\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|       Year  ID Structure capAge capTL edge bcAge Radius     bcTL\n#R|  1    2020 143   Otolith      3   402  982     1    464 189.9470\n#R|  2    2020 143   Otolith      3   402  982     2    754 308.6640\n#R|  3    2020 143   Otolith      3   402  982     3    982 402.0000\n#R|  8754 1987  NA     Scale      3   453  695     1    145 138.0341\n#R|  8755 1987  NA     Scale      3   453  695     2    338 248.5585\n#R|  8756 1987  NA     Scale      3   453  695     3    537 362.5189\n```\n:::\n:::\n\n\nAt this point, I felt the need to see if these calculations \"worked.\" I made a plot of back-calculated length-at-age and noticed that most results were reasonable, but there were a handful of VERY large back-calculated lengths. This seemed like date error rather than systematic calculation error. I was further concerned that there may be errors of very low back-calculated lengths; thus, I used a log scale for the y-axis.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=bcAge,y=bcTL,color=Structure)) +\n  geom_jitter(width=0.2,height=0,alpha=0.5) +\n  scale_y_continuous(trans=\"log10\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/data-examine-1-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThe large back-calculated lengths were from four individual fish, three of which had lengths-at-capture that were clearly errors (i.e., `capTL` over 2000 mm). Additionally, at least two of the small back-calculated lengths were from errors in length-at-capture (i.e., `capTL` less that 50 mm). A few of the other problems appeared related to bad `edge` measurements.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 |> filter(bcTL>1000)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 13 × 9\n#R|      Year    ID Structure capAge capTL  edge bcAge Radius  bcTL\n#R|     <dbl> <dbl> <chr>      <dbl> <dbl> <dbl> <dbl>  <dbl> <dbl>\n#R|   1  2012  2055 Otolith        2  2778   665     1    394 1646.\n#R|   2  2012  2055 Otolith        2  2778   665     2    665 2778 \n#R|   3  2009   208 Otolith        3  3370   740     1    344 1567.\n#R|   4  2009   208 Otolith        3  3370   740     2    547 2491.\n#R|   5  2009   208 Otolith        3  3370   740     3    740 3370 \n#R|   6  2008    69 Otolith        4  4692   925     1    352 1785.\n#R|   7  2008    69 Otolith        4  4692   925     2    531 2693.\n#R|   8  2008    69 Otolith        4  4692   925     3    726 3683.\n#R|   9  2008    69 Otolith        4  4692   925     4    925 4692 \n#R|  10  2004  1098 Otolith        4   460   100     1    333 1532.\n#R|  11  2004  1098 Otolith        4   460   100     2    619 2847.\n#R|  12  2004  1098 Otolith        4   460   100     3    811 3731.\n#R|  13  2004  1098 Otolith        4   460   100     4   1000 4600\n```\n:::\n\n```{.r .cell-code}\ndat2 |> filter(bcTL<80)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 10 × 9\n#R|      Year    ID Structure capAge capTL  edge bcAge Radius  bcTL\n#R|     <dbl> <dbl> <chr>      <dbl> <dbl> <dbl> <dbl>  <dbl> <dbl>\n#R|   1  2014    19 Otolith        2   145   610     1    313 74.4 \n#R|   2  2008   257 Otolith        2    15   667     1    321  7.22\n#R|   3  2008   257 Otolith        2    15   667     2    667 15   \n#R|   4  2006   149 Otolith        3    43   938     1    363 16.6 \n#R|   5  2006   149 Otolith        3    43   938     2    636 29.2 \n#R|   6  2006   149 Otolith        3    43   938     3    938 43   \n#R|   7  2007   319 Otolith        2   302  7110     1    374 15.9 \n#R|   8  2007   319 Otolith        2   302  7110     2    710 30.2 \n#R|   9  2004   135 Otolith        3   160   986     1    482 78.2 \n#R|  10  2004   218 Otolith        3   190   841     1    305 68.9\n```\n:::\n:::\n\n\nI examined the length-at-capture and radius-at-capture data more closely.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat,mapping=aes(x=capTL)) +\n  geom_histogram(bins=100) +\n  scale_x_continuous(trans=\"log10\") +\n  coord_cartesian(ylim=c(0,10))\n## <100 and >1000 seem to be errors\n\nggplot(data=dat,mapping=aes(x=edge)) +\n  geom_histogram(bins=100) +\n  scale_x_continuous(trans=\"log10\") +\n  coord_cartesian(ylim=c(0,10))\n## <200? and >1500 seem to be errors\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-html/data-examine-3a-1.png){fig-align='center' width=768}\n:::\n:::\n\n\nFrom this analysis, it seems that lengths-at-capture less than 100 mm and greater than 1000 mm are data errors. In addition, it seems that edge measurements of less than 200 and greater than 1500 are also data errors. If I had access to the original records, I would attempt to determine if these are data entry errors and fix them. I don't have that access, so I deleted fish with these measurements from the `dat` data frame.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat <- dat |>\n  filter(capTL>100,capTL<1000) |>\n  filter(edge>200,edge<3000)\n```\n:::\n\n\nBecause the original `dat` data frame has now been altered, the regression and creation of `dat2` above needed to be repeated before continuing. **I did not show the repeated code here.**\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|       Year  ID Structure capAge capTL edge bcAge Radius     bcTL\n#R|  1    2020 143   Otolith      3   402  982     1    464 189.9470\n#R|  2    2020 143   Otolith      3   402  982     2    754 308.6640\n#R|  3    2020 143   Otolith      3   402  982     3    982 402.0000\n#R|  8732 1987  NA     Scale      3   453  695     1    145 139.1931\n#R|  8733 1987  NA     Scale      3   453  695     2    338 249.3108\n#R|  8734 1987  NA     Scale      3   453  695     3    537 362.8518\n```\n:::\n:::\n\n\n&nbsp;\n\n# Recreating Figure 6\nA decade variable is added to `dat2` and the data was reduced to only age-2 to age-4 fish, as those were the only ages used in Figure 6.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat3 <- dat2 |>\n  mutate(Decade=floor(Year/10)*10,\n         Decade=ifelse(Decade==2020,2010,Decade),\n         Decade=factor(Decade)) |>\n  filter(bcAge>=2,bcAge<=4)\n```\n:::\n\n\nFigure 6 is a boxplot that can be produced with `geom_boxplot()`, with `Decade` mapped to the x-axis and `bcTL` mapped to the y-axis. Note that the x-axis variables should not be numeric, which is why `Decade` was converted to a factor above. Because of this, the x-axis is modified with `scale_x_discrete()` rather than `scale_x_continuous()`. The rest of functions used here were described in the previous posts related to @mccarricketal_2022.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat3,mapping=aes(x=Decade,y=bcTL)) +\n  geom_boxplot() +\n  geom_text(mapping=aes(label=paste(\"Age\",bcAge)),check_overlap=TRUE,\n            x=Inf,y=Inf,vjust=1.2,hjust=1.1) +\n  scale_y_continuous(name=\"Back-calculated length (mm)\",\n                     limits=c(100,700),breaks=scales::breaks_width(100),\n                     expand=expansion(mult=0)) +\n  scale_x_discrete(name=\"Decade\") +\n  lemon::facet_rep_wrap(vars(bcAge),ncol=1) +\n  theme_bw() +\n  theme(panel.grid=element_blank(),\n        strip.text=element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig6-1.png){fig-align='center' width=432}\n:::\n:::\n\n\n&nbsp;\n\n# Recreating Figure 7\nFigure 7 is a bar chart based on summarized data, which needs to be constructed from `dat2`. Below, `dat2` is restricted to only otoliths, the two periods shown in Figure 7 are created and converted to a factor, and then the sample size and the mean and standard error of back-calculated total lengths are calculated by age for each period. `.drop=FALSE` is used in `group_by()` so that the same number of ages will be shown for both periods, though both periods don't have the same range of ages.^[So, some ages will have `NA` for the mean and SE.] This will make the bars in the plot before appear in their proper locations even if a result is missing for the other period.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat4 <- dat2 |> \n  filter(Structure==\"Otolith\") |>\n  mutate(Period=ifelse(Year<2011,\"2002-2010\",\"2011-2020\"),\n         Period=factor(Period,levels=c(\"2002-2010\",\"2011-2020\")),\n         bcAge=factor(bcAge)) |>\n  group_by(Period,bcAge,.drop=FALSE) |>\n  summarize(n=n(),\n            mnTL=mean(bcTL,na.rm=TRUE),\n            seTL=FSA::se(bcTL,na.rm=TRUE)) |>\n  ungroup()\nFSA::headtail(dat4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|        Period bcAge    n     mnTL       seTL\n#R|  1  2002-2010     1 1190 174.2867  0.9124273\n#R|  2  2002-2010     2 1048 302.2455  1.2765006\n#R|  3  2002-2010     3  455 405.1318  2.2456338\n#R|  20 2011-2020     9    4 498.3248 29.0737028\n#R|  21 2011-2020    10    4 534.1058 26.7635020\n#R|  22 2011-2020    11    1 524.0000         NA\n```\n:::\n:::\n\n\nThese summary data are then ready to make a bar chart, very similar to what was done in [this post](https://fishr-core-team.github.io/fishR/blog/posts/2023-3-26_McCarricketal2022_Fig4/#recreating-figure-4). Note here, though, that the width of the bars (in `geom_col()`) was reduced to create more room between the bars at each age. The `width=` of dodging in `position_dodge()` had to then be reduced a commensurate amount so that the bars at each age would touch. Finally, `legend.key.width=` and `legend.key.height=` were used in `theme()` to make the elongated \"keys\" in the legend as was done in Figure 7.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npd <- position_dodge(width=0.7)\n\nggplot(dat=dat4,mapping=aes(x=bcAge,y=mnTL,fill=Period)) +\n  geom_errorbar(mapping=aes(ymin=mnTL-seTL,ymax=mnTL+seTL),\n                position=pd,width=0.5) +\n  geom_col(position=pd,color=\"black\",width=0.7) +\n  scale_x_discrete(name=\"Age (years)\") +\n  scale_y_continuous(name=\"Mean back-calculated length (mm)\",\n                     limits=c(0,600),breaks=scales::breaks_width(100),\n                     expand=expansion(mult=0)) +\n  scale_fill_manual(values=c(\"2002-2010\"=\"gray10\",\"2011-2020\"=\"gray70\")) +\n  theme_bw() +\n  theme(panel.grid=element_blank(),\n        strip.text=element_blank(),\n        legend.position=c(0,1),\n        legend.justification=c(-0.1,1.1),\n        legend.title=element_blank(),\n        legend.key.width=unit(15,units=\"mm\"),\n        legend.key.height=unit(3,units=\"mm\"),\n        legend.text=element_text(size=11))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig7-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n:::{.callout-warning}\nI am not a fan of showing \"error bars\" that are only one SE. This is akin to showing a 68% confidence interval, which is not something that someone would usually do. I did that here because that is what was done in the published Figure 7, but I urge you not to do this ... show a proper confidence interval instead.\n:::\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}