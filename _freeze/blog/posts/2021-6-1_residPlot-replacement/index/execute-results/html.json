{
  "hash": "4edb5d9835c4598b7970ec1626b81678",
  "result": {
    "markdown": "---\ntitle: Replace residPlot() with ggplot\ndescription: Using `ggplot()` as an alternative to `residPlot()` which was removed from `FSA`.\nauthor: Derek H. Ogle\ndate: 6/1/2021\nimage: preview.png\ncategories:\n  - FSA\n  - ggplot2\n---\n\n\n\n\n:::{.callout-note}\nThe following packages are loaded for use below. One function from `nlstools` is also used but the entire package is not loaded here. I also set the default `ggplot` theme to `theme_bw()` for a classic \"black-and-white\" plot (rather than the default plot with a gray background).\n:::\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(FSA)          ## for peek(), vbFuns(), vbStarts(), SpotVA1\nlibrary(dplyr)        ## for mutate()\nlibrary(ggplot2)\nlibrary(patchwork)    ## placing plots (in conclusion)\ntheme_set(theme_bw())\n```\n:::\n\n\n:::{.callout-note}\nSome functions illustrated below were in the `FSA` package but have now been removed and put into the non-released `FSAmisc` package that I maintain. These functions are used below **only** to show what could be done in older versions of `FSA` but should now be done as described in this post. **DO NOT USE any of the functions below that begin with `FSAmisc::`.** \n:::\n\n&nbsp;\n\n# Introduction\nWe deprecated `residPlot()` from FSA v0.9.0 and fully removed it by the start of 2022. We took this action to make `FSA` more focused on fisheries applications and to eliminate \"black box\" functions. `residPlot()` was originally designed for students to quickly visualize residuals from one- and two-way ANOVAs and simple, indicator variable, and logistic regressions.^[Over time functionality for non-linear regressions was added.] We now feel that students are better served by learning how to create these visualizations using methods provided by `ggplot2`, which require more code, but are more modern, flexible, and transparent.\n\nThe basic plots produced by `residPlot()` are recreated here using `ggplot2` to provide a resource to help users that relied on `residPlot()` transition to `ggplot2`.\n\n&nbsp;\n\n# Example Data\nMost examples below use the `Mirex` data set from `FSA`, which contains the concentration of mirex in the tissue and the body weight of two species of salmon (`chinook` and `coho`) captured in six years. The `year` variable is converted to a factor for modeling purposes and a new variable is created that indicates if the mirex concentration was greater that 0.2 or not. These same data were used in [this post](../2021-5-25_fitPlot-replacement) about removing `fitPlot()` from `FSA`.^[`peek()` from `FSA` is used to examine a portion of the data from evenly-spaced row.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndata(Mirex,package=\"FSA\")\nMirex <- Mirex |>\n  mutate(year=factor(year),\n         gt2=ifelse(mirex>0.2,1,0))\npeek(Mirex,n=10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      year weight mirex species gt2\n#R|  1   1977   0.41  0.16 chinook   0\n#R|  14  1977   3.29  0.23    coho   1\n#R|  27  1982   0.70  0.10    coho   0\n#R|  41  1982   5.09  0.27    coho   1\n#R|  54  1986   1.82  0.12 chinook   0\n#R|  68  1986   8.40  0.13 chinook   0\n#R|  81  1992  10.00  0.48 chinook   1\n#R|  95  1996   5.70  0.16    coho   0\n#R|  108 1999   5.11  0.11    coho   0\n#R|  122 1999  11.82  0.09 chinook   0\n```\n:::\n:::\n\n\n&nbsp;\n\n# One-Way ANOVA\nThe code below fits a one-way ANOVA model to examine if mean weight differs by species.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naov1 <- lm(weight~species,data=Mirex)\nanova(aov1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: weight\n#R|             Df Sum Sq Mean Sq F value    Pr(>F)    \n#R|  species     1  282.4 282.399  27.657 6.404e-07 ***\n#R|  Residuals 120 1225.3  10.211                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\n`residPlot()` from `FSA` produced a boxplot of residuals by group (left) and a histogram of residuals (right).\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::residPlot(aov1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residPlot_1way_A-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n&nbsp;\n\nA data frame of the two variables used in the ANOVA appended with the fitted values and residuals from the model fit must be made to construct this plot using `ggplot()`. Studentized residuals are included below in case you would prefer to plot them.^[These are \"internally\" Studentized residuals. \"Externally\" Studentized residuals can be obtained with `rstandard()`.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntmp <- Mirex |>\n  select(weight,species) |>\n  mutate(fits=fitted(aov1),\n         resids=resid(aov1),\n         sresids=rstudent(aov1))\npeek(tmp,n=8)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      weight species     fits     resids    sresids\n#R|  1     0.41 chinook 6.314776 -5.9047761 -1.8814369\n#R|  17    4.77    coho 3.257091  1.5129091  0.4762846\n#R|  35    2.92 chinook 6.314776 -3.3947761 -1.0710643\n#R|  52    1.70    coho 3.257091 -1.5570909 -0.4902213\n#R|  70    9.53 chinook 6.314776  3.2152239  1.0139117\n#R|  87    0.90    coho 3.257091 -2.3570909 -0.7430562\n#R|  105   2.61    coho 3.257091 -0.6470909 -0.2035546\n#R|  122  11.82 chinook 6.314776  5.5052239  1.7507263\n```\n:::\n:::\n\n\n&nbsp;\n\nThe histogram of residuals is constructed with `geom_histogram()` below. Note that the color of the histogram bars are modified and the bin width is set to better control the number of bars in the histogram. Finally, the bottom multiplier for the y-axis is set to zero so that that histogram bars do not \"hover\" above the x-axis.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=tmp,mapping=aes(x=resids)) +\n  geom_histogram(color=\"gray30\",fill=\"gray70\",binwidth=0.5) +\n  scale_y_continuous(expand=expansion(mult=c(0,0.05)))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residplot_1wayH-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\nThe boxplot of residuals by group (species in this case) is constructed with `geom_boxplot()` below (again controlling the colors of the boxplot).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=tmp,mapping=aes(x=species,y=resids)) +\n  geom_boxplot(color=\"gray30\",fill=\"gray70\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residplot_1wayB-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\nThese plots can be further modified using methods typical for ggplot (see conclusion section).\n\n&nbsp;\n\n# Two-Way ANOVA\nThe code below fits a two-way ANOVA model to examine if mean weight differs by species, by year, or by the interaction between species and year.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naov2 <- lm(weight~year*species,data=Mirex)\nanova(aov2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: weight\n#R|                Df Sum Sq Mean Sq F value    Pr(>F)    \n#R|  year           5 281.86  56.373  6.9954 1.039e-05 ***\n#R|  species        1 221.69 221.689 27.5099 7.648e-07 ***\n#R|  year:species   5 117.69  23.538  2.9208   0.01628 *  \n#R|  Residuals    110 886.44   8.059                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\n`residPlot()` from `FSA` showed a boxplot of residuals by each combination of the two factor variables (left) and a histogram of the residuals (right).\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::residPlot(aov2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residPlot_2way_A-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n&nbsp;\n\nA data frame of the three variables used in the ANOVA appended with the fitted values and residuals from the model fit must be constructed.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntmp <- Mirex |>\n  select(weight,species,year) |>\n  mutate(fits=fitted(aov2),\n         resids=resid(aov2),\n         sresids=rstudent(aov2))\n```\n:::\n\n\n&nbsp;\n\nThe histogram of residuals is constructed exactly as before and won't be repeated here. The boxplot of residuals by group is constructed with one of the factor variables on the x-axis and the other factor variable as separate facets.^[These two variables can, of course, be exchanged. However, I generally prefer to have the variable with more levels on the x-axis.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=tmp,mapping=aes(x=year,y=resids)) +\n  geom_boxplot(color=\"gray30\",fill=\"gray70\") +\n  facet_wrap(vars(species))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residplot_2wayB-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n&nbsp;\n\n# Simple Linear Regression\nThe code below fits a simple linear regression for examining the relationship between mirex concentration and salmon weight.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nslr <- lm(mirex~weight,data=Mirex)\nanova(slr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: mirex\n#R|             Df  Sum Sq  Mean Sq F value    Pr(>F)    \n#R|  weight      1 0.22298 0.222980  26.556 1.019e-06 ***\n#R|  Residuals 120 1.00758 0.008396                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\n`residPlot()` from `FSA` showed a scatterplot of residuals versus fitted values (left) and a histogram of residuals (right).\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::residPlot(slr)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residPlot_SLR_A-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n&nbsp;\n\nA data frame of the two variables used in the ANOVA appended with the fitted values and residuals from the model fit must be constructed.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntmp <- Mirex |>\n  select(weight,mirex) |>\n  mutate(fits=fitted(slr),\n         resids=resid(slr),\n         sresids=rstudent(slr))\n```\n:::\n\n\n&nbsp;\n\nThe histogram of residuals is constructed exactly as before and won't be repeated here. The scatterplot of residuals versus fitted values is constructed with `geom_point()` as below. Note that `geom_hline()` is used to place the horizontal line at 0 on the y-axis.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=tmp,mapping=aes(x=fits,y=resids)) +\n  geom_point() +\n  geom_hline(yintercept=0,linetype=\"dashed\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residplot_slrP-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\nIt is also possible to include a loess smoother to help identify a possible nonlinearity in this residual plot.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=tmp,mapping=aes(x=fits,y=resids)) +\n  geom_point() +\n  geom_hline(yintercept=0,linetype=\"dashed\") +\n  geom_smooth()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residplot_slrP2-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n# Indicator Variable Regression\nThe code below fits an indicator variable regression to examine if the relationship between mirex concentration and salmon weight differs betwen species.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nivr <- lm(mirex~weight*species,data=Mirex)\nanova(ivr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: mirex\n#R|                  Df  Sum Sq  Mean Sq F value    Pr(>F)    \n#R|  weight           1 0.22298 0.222980 26.8586 9.155e-07 ***\n#R|  species          1 0.00050 0.000498  0.0600   0.80690    \n#R|  weight:species   1 0.02744 0.027444  3.3057   0.07158 .  \n#R|  Residuals      118 0.97964 0.008302                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\n`residPlot()` from `FSA` is the same for an IVR as for an SLR, except that the points on the residual plot (left) had different colors for the different groups.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::residPlot(ivr)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residPlot_IVR_A-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n&nbsp;\n\nA data frame of the three variables used in the ANOVA appended with the fitted values and residuals from the model fit must be constructed.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntmp <- Mirex |>\n  select(weight,mirex,species) |>\n  mutate(fits=fitted(ivr),\n         resids=resid(ivr),\n         sresids=rstudent(ivr))\n```\n:::\n\n\n&nbsp;\n\nThe histogram of residuals is constructed exactly as before and won't be repeated here. The scatterplot of residuals versus fitted values is constructed with `geom_point()`. Note that `color=` and `shape=` are both set equal to the factor variable to change the color and plotting character to represent the different groups.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=tmp,mapping=aes(x=fits,y=resids,color=species,shape=species)) +\n  geom_point() +\n  geom_hline(yintercept=0,linetype=\"dashed\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residplot_ivrP-1.png){fig-align='center' width=432}\n:::\n:::\n\n\n&nbsp;\n\n# Nonlinear Regression\nThe following code fits a von Bertalanffy growth function (VBGF) to the total length and age data for spot found in the `SpotVA1` data frame built into `FSA`. Fitting the VBGF is [described in more detail here](../2019-12-31_vonB_plots_1/).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvb <- vbFuns()\nvbs <- vbStarts(tl~age,data=SpotVA1)\nnlreg <- nls(tl~vb(age,Linf,K,t0),data=SpotVA1,start=vbs)\n```\n:::\n\n\n&nbsp;\n\n`residPlot()` from `FSA` produced plots exactly as for a simple linear regression.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::residPlot(nlreg)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residPlot_nls_A-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n&nbsp;\n\nA data frame of the two variables used in the ANOVA appended with the fitted values and residuals from the model fit must be constructed. The `rstudent()` function does not work for non-linear models, but the Studentized residuals are computed with `nlsResiduals()` from `nlstools`. However, these values are \"buried\" in the `Standardized residuals` column of the `resi2` matrix returned by that function; thus, it takes a little work to extract them as shown below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntmp <- SpotVA1 |>\n  select(tl,age) |>\n  mutate(fits=fitted(nlreg),\n         resids=resid(nlreg),\n         sresids=nlstools::nlsResiduals(nlreg)$resi2[,\"Standardized residuals\"])\npeek(tmp,n=8)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|        tl age      fits     resids    sresids\n#R|  1    6.5   0  7.348034 -0.8480343 -0.8051925\n#R|  58   8.3   1  9.251581 -0.9515812 -0.9035082\n#R|  115  8.5   1  9.251581 -0.7515812 -0.7136121\n#R|  173  9.7   1  9.251581  0.4484188  0.4257650\n#R|  230  9.8   2 10.771696 -0.9716957 -0.9226066\n#R|  288 10.5   2 10.771696 -0.2716957 -0.2579700\n#R|  345 11.5   3 11.985613 -0.4856128 -0.4610802\n#R|  403 13.9   4 12.955010  0.9449900  0.8972498\n```\n:::\n:::\n\n\n&nbsp;\n\nOnce this data frame is constructed the residual plot and histogram of residuals are constructed exactly as for linear regression and won't be repeated here.\n\n&nbsp;\n\n# Conclusion\nThe `residPlot()` function in `FSA` was removed by 2022. This post describes a more transparent (i.e., not a \"black box\") and flexible set of methods for constructing similar plots using `ggplot2` for those who will need to transition away from using `residPlot()`.^[Different \"residual plots\" are available in `plot()` (from base R when given an object from `lm()`), [`car::residualPlots()`](https://rdrr.io/cran/car/man/residualPlots.html), [`DHARMa::plotResiduals()`](https://www.rdocumentation.org/packages/DHARMa/versions/0.4.1/topics/plotResiduals), and [`ggResidpanel::resid_panel()`](https://github.com/goodekat/ggResidpanel).]\n\nAs mentioned in the examples above, each plot can be modified further using typical methods for `ggplot2`. These changes were not illustrated above to minimize the amount of code shown in this post. However, as an example, the code below shows a possible modification of the IVR residual plot shown above.^[`patchwork` is used here to place the plots side-by-side.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Recreate the data frame of results for the IVR\ntmp <- Mirex |>\n  select(weight,mirex,species) |>\n  mutate(fits=fitted(ivr),\n         resids=resid(ivr),\n         sresids=rstudent(ivr))\n\n## Create a general theme that can be applied to both plots\ntheme_DHO <- theme_bw() +\n  theme(panel.grid.major=element_line(color=\"gray90\",linetype=\"dashed\"),\n        panel.grid.minor=element_blank(),\n        axis.title=element_text(size=rel(1.25)),\n        axis.text=element_text(size=rel(1.1)),\n        legend.position=c(0,1),\n        legend.justification=c(-0.05,1.02),\n        legend.title=element_blank(),\n        legend.text=element_text(size=rel(1.1)))\n\n## Construct the residual plot\nr1 <- ggplot(tmp,aes(x=fits,y=sresids,color=species)) +\n  geom_point(size=1.5,alpha=0.5) +\n  geom_hline(yintercept=0,linetype=\"dashed\") +\n  geom_smooth(se=FALSE) +\n  scale_y_continuous(name=\"Studentized Residuals\") +\n  scale_x_continuous(name=\"Fitted Values\") +\n  scale_color_manual(values=c(\"#E69F00\",\"#0072B2\"),guide=\"none\") +\n  theme_DHO\n\n## Construct the histogram of residuals\nr2 <- ggplot(tmp,aes(x=sresids,color=species,fill=species)) +\n  geom_histogram(alpha=0.5,binwidth=0.25) +\n  scale_y_continuous(name=\"Frequency\",expand=expansion(mult=c(0,0.05))) +\n  scale_x_continuous(name=\"Studentized Residuals\") +\n  scale_color_manual(values=c(\"#E69F00\",\"#0072B2\"),\n                     aesthetics=c(\"color\",\"fill\")) +\n  theme_DHO\n\n## Put plots side-by-side (the \"+\" is provided by patchwork)\nr1 + r2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/residPlot_Final-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}