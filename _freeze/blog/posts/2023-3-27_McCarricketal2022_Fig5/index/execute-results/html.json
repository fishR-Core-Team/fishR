{
  "hash": "5c8a23eb15fccadb8cc0bff340ad0b42",
  "result": {
    "markdown": "---\ntitle: McCarrick et al. (2022) Age Composition Plot\ndescription: Using ggplot2 to recreate the age composition by year figure in McCarrick et al. (2022).\nauthor: Derek H. Ogle\ndate: 3/27/2023\nimage: preview.png\ncategories:\n  - ggplot2\n  - area chart\n  - bar chart\n  - facet\n  - color\n  - Data Wrangling\n  - Age\n---\n\n\n:::{.callout-important}\n## Series Note\nThis is the fourth of several posts related to @mccarricketal_2022.\n:::\n\n# Introduction\n@mccarricketal_2022 examined the population dynamics of Yellowstone Cutthroat Trout (*Oncorhynchus clarkii bouvieri*) in Henrys Lake, Idaho over a nearly two decade period. Their [Figure 5](https://meridian.allenpress.com/view-large/figure/14538510/i1944-687X-13-1-169-f05.tif) showed the relative age composition of Cutthroat Trout across years. I use `ggplot2` to recreate that figure here.\n\nThe following packages are loaded for use below. A few functions from each of `FSA`, `plyr`, `lemon`, and `forcats` are used with `::` such that the entire packages are not attached here.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # for dplyr, ggplot2 packages\n```\n:::\n\n\n&nbsp;\n\n# Data Wrangling\n@mccarricketal_2022 provided raw data for Figure 2 in a MSWord table as a supplement. I copied the table from Word, pasted it into Excel, and saved it for loading here.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat <- readxl::read_xlsx(\"YCT_AgeComp.xlsx\")\ndat\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 19 × 12\n#R|      Year `Age 1` `Age 2` `Age 3` `Age 4` `Age 5` `Age 6` `Age 7` `Age 8` `Age 9`\n#R|     <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>\n#R|   1  2002   0.113   0.46    0.394   0.034   0       0       0       0       0    \n#R|   2  2003   0.207   0.207   0.194   0.289   0.058   0.025   0       0       0.019\n#R|   3  2004   0.39    0.472   0.084   0.034   0.003   0.007   0.007   0.003   0    \n#R|   4  2005   0.368   0.527   0.078   0.015   0.013   0       0       0       0    \n#R|   5  2006   0.091   0.276   0.52    0.107   0.002   0.004   0       0       0    \n#R|   6  2007   0.025   0.708   0.13    0.128   0.009   0       0       0       0    \n#R|   7  2008   0       0.536   0.298   0.146   0.021   0       0       0       0    \n#R|   8  2009   0.051   0.27    0.502   0.177   0       0       0       0       0    \n#R|   9  2010   0.028   0.753   0.092   0.116   0.008   0.003   0       0       0    \n#R|  10  2011   0.003   0.774   0.187   0.029   0.005   0.003   0       0       0    \n#R|  11  2012   0.017   0.594   0.348   0.029   0.004   0.006   0       0       0    \n#R|  12  2013   0.004   0.61    0.22    0.14    0.02    0.002   0.004   0       0    \n#R|  13  2014   0.007   0.353   0.437   0.136   0.05    0.013   0.002   0.002   0    \n#R|  14  2015   0.021   0.399   0.239   0.271   0.031   0.04    0       0       0    \n#R|  15  2016   0       0.594   0.238   0.082   0.053   0.033   0       0       0    \n#R|  16  2017   0.02    0.518   0.197   0.197   0.027   0.035   0       0.007   0    \n#R|  17  2018   0.053   0.137   0.505   0.148   0.101   0.013   0.031   0.013   0    \n#R|  18  2019   0.013   0.765   0.127   0.037   0.027   0.014   0.004   0.013   0    \n#R|  19  2020   0.005   0.206   0.677   0.096   0.003   0.005   0.005   0.002   0    \n#R|  # … with 2 more variables: `Age 10` <dbl>, `Age 11` <dbl>\n```\n:::\n:::\n\n\nThe data were provided in a wide format that needs to be \"tidied\" to a long format with the proportions at age in the `Age X` columns stacked on top of each other with a corresponding variable that indicates the age. Note that the columns to pivot in `cols=` were selected by ignoring `year` and, thus, leaving all of the `Age X` columns.^[The columns also could have been selected with `starts_with(\"Age\")`, among other possibilities.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat <- dat |>\n  pivot_longer(cols=-Year,names_to=\"Age\",values_to=\"Proportion\")\nFSA::headtail(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      Year    Age Proportion\n#R|  1   2002  Age 1      0.113\n#R|  2   2002  Age 2      0.460\n#R|  3   2002  Age 3      0.394\n#R|  207 2020  Age 9      0.000\n#R|  208 2020 Age 10      0.001\n#R|  209 2020 Age 11      0.000\n```\n:::\n:::\n\n\nThe `Age` variable should be converted to a factor so that the levels can be controlled, otherwise \"Age 10\" will follow \"Age 1\".\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat <- dat |>\n  mutate(Age=factor(Age,levels=c(\"Age 1\",\"Age 2\",\"Age 3\",\"Age 4\",\"Age 5\",\"Age 6\",\n                                 \"Age 7\",\"Age 8\",\"Age 9\",\"Age 10\",\"Age 11\")))\n```\n:::\n\n\nThis data frame is ready for recreating Figure 5.\n\n&nbsp;\n\n# Recreating Figure 5\nFigure 5 is an \"area plot\" which is easily constructed in `ggplot2` with `geom_area()`, with the variable that defines the colored areas (i.e., `Age`) mapped to `fill=`.^[I plotted every other on the x-axis as the font needed to be so small to show every year at in @mccarricketal_2022.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_area() +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  theme_bw() +\n  theme(panel.grid=element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-1-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nI won't address color here (but see further below) as these colors are no uglier than what is shown in the published Figure 5. However, there are other adjustments that need to be made to match Figure 5. \n\nFirst, the ages above are stacked opposite of what is in Figure 5; i.e., age-1 is at the top, age-2 below that, etc. rather than age-1 at the bottom, age-2 on top of that, etc. The order of stacking is reversed with `position=` in `geom_area()` as shown below. Second, the authors included two digits for the values on the y-axis for some reason. Assuming this behavior is desired it can be obtained with `scales::label_number()` in `scale_y_continuous()` as shown below.^[This was demonstrated in [this post](../2023-3-15-Axis_Magic/#numeric-label-format).]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_area(position=position_stack(reverse=TRUE)) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1),\n                     label=scales::label_number(0.01)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  theme_bw() +\n  theme(panel.grid=element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-2-1.png){fig-align='center' width=576}\n:::\n:::\n\n\nThird, the legend needs to be moved to below the x-axis. This is easily accomplished with `legend.position=\"bottom\"` in `theme()`. However, doing this alone shows the legend in three rows. One row was used for the legend as shown below with `guides()`. Finally, other theme options were altered to remove the legend title and make the legend symbols and text smaller.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_area(position=position_stack(reverse=TRUE)) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1),\n                     label=scales::label_number(0.01)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  guides(fill=guide_legend(nrow=1)) +\n  theme_bw() +\n  theme(panel.grid=element_blank(),\n        legend.position=\"bottom\",\n        legend.title=element_blank(),\n        legend.key.size=unit(2,\"mm\"),\n        legend.text=element_text(size=7))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-1.png){fig-align='center' width=480}\n:::\n:::\n\n\nThis largely recreates Figure 5 in @mccarricketal_2022.\n\n&nbsp;\n\n# Possible Modifications\nArea plots are notorious for being difficult for readers to interpret.^[See [this](https://leancrew.com/all-this/2011/11/i-hate-stacked-area-charts/) for example.] Below I offer some modifications that may(?) aid interpretation.\n\n### Lump Ages\nMany potential ages are shown in Figure 5 though ages greater than age-5 are rarely visible (or noticeable) as they never represent more than 10% in total or 4% individually of the fish in any given year.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Find maximum proportion by age, is that more than 5%\ndat |> group_by(Age) |> summarize(maxP=max(Proportion))\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 11 × 2\n#R|     Age     maxP\n#R|     <fct>  <dbl>\n#R|   1 Age 1  0.39 \n#R|   2 Age 2  0.774\n#R|   3 Age 3  0.677\n#R|   4 Age 4  0.289\n#R|   5 Age 5  0.101\n#R|   6 Age 6  0.04 \n#R|   7 Age 7  0.031\n#R|   8 Age 8  0.013\n#R|   9 Age 9  0.019\n#R|  10 Age 10 0.002\n#R|  11 Age 11 0.001\n```\n:::\n:::\n\n\nThe number of colors used in the plot, and the number of areas that the reader looks for, can be reduced by lumping together ages that are not well-represented in the data. Below `fct_collapse()` from `forcats` is used to collapse the \"Age 6\" to \"Age 11\" levels in `Age` to one level called \"Age 6+\". To preserve the original data this data frame was called `dat2`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 <- dat |>\n  mutate(Age=forcats::fct_collapse(Age,`Age 6+`=c(\"Age 6\",\"Age 7\",\"Age 7\",\"Age 8\",\n                                                  \"Age 9\",\"Age 10\",\"Age 11\")))\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      Year    Age Proportion\n#R|  1   2002  Age 1      0.113\n#R|  2   2002  Age 2      0.460\n#R|  3   2002  Age 3      0.394\n#R|  207 2020 Age 6+      0.000\n#R|  208 2020 Age 6+      0.001\n#R|  209 2020 Age 6+      0.000\n```\n:::\n:::\n\n\nHowever, \"Age 6+\" was simply repeated for the original \"Age 6\", \"Age 7\", etc. The proportions for these ages should be summed, within each year, to get a proper proportion of \"Age 6+\" fish.^[Summing the proportions for the ages that were lumped will just return the proportion for those ages.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 <- dat2 |>\n  group_by(Year,Age) |>\n  summarize(Proportion=sum(Proportion)) |>\n  ungroup()\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      Year    Age Proportion\n#R|  1   2002  Age 1      0.113\n#R|  2   2002  Age 2      0.460\n#R|  3   2002  Age 3      0.394\n#R|  112 2020  Age 4      0.096\n#R|  113 2020  Age 5      0.003\n#R|  114 2020 Age 6+      0.013\n```\n:::\n:::\n\n\nTo save some typing below, I set the theme to the theme items above with the exception that I moved the legend back to the right where I think it is more appropriate.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntheme_set(\n  theme_bw() +\n  theme(panel.grid=element_blank(),\n        legend.title=element_blank(),\n        legend.key.size=unit(3,\"mm\"),\n        legend.text=element_text(size=8))\n)\n```\n:::\n\n\nThe code for Figure 5 is largely repeated below with these data. However, I reversed the order of the labels in the legend with `guides()` so that the labels more naturally followed how the areas were plotted and I removed the unnecessary extra digit in the y-axis labels.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_area(position=position_stack(reverse=TRUE)) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  guides(fill=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-alt1-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n### Color\nChanging the color is not necessarily going to make the figure easier to interpret. However, a gradient of color can be used to more clearly represent the gradient of age. Here, I form a gradient of grays with `scale_fill_grey()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_area(position=position_stack(reverse=TRUE)) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  scale_fill_grey(start=0.2,end=0.8) +\n  guides(fill=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-alt2-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nA sequential palette that ranges from dark green to light blue is used below with `scale_fill_brewer()`. A variety of palettes may be chosen in this function as described in its documentation. Note that `direction=-1` was used here to reverse the palette order as I preferred the darker colors for age-1 and the lighter colors for age-6+.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_area(position=position_stack(reverse=TRUE)) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  scale_fill_brewer(palette=\"BuGn\",direction=-1) +\n  guides(fill=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-alt3-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nOther palette algorithms can also be used. Below, `scale_fill_viridis_d()` is used as an example.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_area(position=position_stack(reverse=TRUE)) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  scale_fill_viridis_d(begin=0.25,end=0.9) +\n  guides(fill=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-alt4-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n:::{.callout-tip}\nThere is both an art and a science behind choosing colors for plots. Unfortunately, I am not strong nor fully knowledgeable in either. Thus, I show how to alter colors here, but I don't claim that these choices are ideal.\n:::\n\n### Add Lines\nI sometimes feel that the colors in area plots \"run together\" in my eyes. One way to make more clear \"breaks\" is to highlight the color changes. Below I also map `Age` to `color=`, use `scale_color_viridis_d()` with the same options as `scale_fill_viridis_d()`, except that for the fill I set a slight transparency with `alpha=`. Here `color=` is used for the boundaries of the areas and since the fill was made transparent these boundaries are a bit darker and, thus, appear as lines between the areas. Further note that both `fill=` and `color=` had to be \"reversed\" in `guides()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Year,y=Proportion,fill=Age,color=Age)) +\n  geom_area(position=position_stack(reverse=TRUE),linewidth=0.75) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  scale_color_viridis_d(begin=0.25,end=0.9) +\n  scale_fill_viridis_d(begin=0.25,end=0.9,alpha=0.75) +\n  guides(fill=guide_legend(reverse=TRUE),\n         color=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-alt5-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n### Bar Chart\nMost people that eschew the use of area plots suggests using bar charts instead. This is easily accomplished here by replacing `geom_area()` with `geom_col()`. However, the limits of the x-axis will need to be extended by one year on both sides so that the first and last year will be shown correctly.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Year,y=Proportion,fill=Age)) +\n  geom_col(position=position_stack(reverse=TRUE)) +\n  scale_y_continuous(expand=expansion(mult=0),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2001,2021),breaks=scales::breaks_width(2)) +\n  scale_fill_viridis_d(begin=0.25,end=0.9) +\n  guides(fill=guide_legend(reverse=TRUE))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-alt6-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n### Facets\nFinally, I think that if the goal is to show annular trends for the specific ages, that they should be plotted as lines for each age. Here lines are used with `geom_line()` and faceting was used on `Age`. The use of color is superfluous here, but I kept it for comparing with the previous options.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Year,y=Proportion,color=Age)) +\n  geom_line(linewidth=0.75) +\n  scale_y_continuous(expand=expansion(mult=c(0,0.025)),\n                     breaks=scales::breaks_width(0.1)) +\n  scale_x_continuous(expand=expansion(mult=0),\n                     limits=c(2002,2020),breaks=scales::breaks_width(2)) +\n  scale_color_viridis_d(begin=0.25,end=0.9) +\n  lemon::facet_rep_wrap(vars(Age),ncol=1,strip.position=\"right\") +\n  theme(legend.position=\"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-fig5-alt7-1.png){fig-align='center' width=432}\n:::\n:::\n\n\nIn my view, it is much easier to decipher what is going on with age-2 to age-4 fish from this plot.\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}