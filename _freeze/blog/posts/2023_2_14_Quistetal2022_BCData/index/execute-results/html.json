{
  "hash": "b9dd8d6f569e4c4f77522ff8bf1fcb5b",
  "result": {
    "markdown": "---\ntitle: Quist et al. (2022) Back-Calculation Figure\ndescription: Using ggplot2 to recreate the back-calculated length-at-age figure in Quist et al. (2022).\nauthor: Derek H. Ogle\ndate: 2/14/2023\nimage: preview.png\ncategories:\n  - ggplot2\n  - Growth\n---\n\n\n# Introduction\n@quistetal_2022 examined three structures (scales, sectioned otoliths, and whole otoliths) to estimate age of Yellowstone Cutthroat Trout (*Oncorhynchus clarkii bouvieri*). In a [previous post](../2023_2_13_Quistetal2022_AgeData) I largely recreated their Figures 1 and 2 related to age precision and bias between readers and between structures. In this post I attempt to recreate [their Figure 3](https://allen.silverchair-cdn.com/allen/content_public/journal/jfwm/13/2/10.3996_jfwm-21-095/6/m_i1944-687x-13-2-544-f03.png?Expires=1678831232&Signature=JxY~wr4kA0hso16992zOn2tYgSuS1iQA0ShHkN114sxfxPIgy-RWxnzEWGJGlGKEIkyVCm2ityRBlsYkyCYsmvtkPaQBLV2ISFV4C-yQI88DFCNJB4-H-vzwPZwnLGOBXM-ylhNvIos2vqJcHlwi89CHyFd68bRyyhySViARpwFzbhGKW8NSTZtVpN3y66rSCI5ZWA6aaqDQEZXqKX65vcr19KJv4g8gwDXf2exOhEO7LJEGVYdhsxZqZ0DH4spz8qQt5uqQnASMg66oI7eTx2kV89hgtj3a-KUwDn4mdZGAu2rnOD-a3LOqsLKZ9xk1ezBj5aPC0dr~c-0W5GZ37w__&Key-Pair-Id=APKAIE5G5CRDK6RD3PGA) which examined back-calculated lengths-at-age between structures (and observed lengths-at-age).\n\n&nbsp;\n\n# Getting Setup\nThe following packages are loaded for use below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # for dplyr, ggplot2 packages\n```\n:::\n\n\nThe following `ggplot2` theme was used below.^[See [this post](../2022-12-22_AFS_Style_Figures/) for more information on creating and using `ggplot2` themes.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntheme_q <- function(base_size=14) {\n  theme_bw(base_size=base_size) +\n    theme(\n      # margin for the plot\n      plot.margin=unit(c(0.5,0.5,0.5,0.5),\"cm\"),\n      # set axis label (i.e., title) colors and margins\n      axis.title.y=element_text(colour=\"black\",margin=margin(t=0,r=10,b=0,l=0)),\n      axis.title.x=element_text(colour=\"black\",margin=margin(t=10,r=0,b=0,l=0)),\n      # set tick label color, margin, and position and orientation\n      axis.text.y=element_text(colour=\"black\",margin=margin(t=0,r=5,b=0,l=0),\n                               vjust=0.5,hjust=1),\n      axis.text.x=element_text(colour=\"black\",margin=margin(t=5,r=0,b=0,l=0),\n                               vjust=0,hjust=0.5,),\n      # set size of the tick marks for y- and x-axis\n      axis.ticks=element_line(linewidth=0.5),\n      # adjust length of the tick marks\n      axis.ticks.length=unit(0.2,\"cm\"),\n      # set the axis size,color,and end shape\n      axis.line=element_line(colour=\"black\",linewidth=0.5,lineend=\"square\"),\n      # adjust size of text for legend\n      legend.text=element_text(size=12),\n      # remove grid\n      panel.grid=element_blank()\n    )\n}\n```\n:::\n\n\n&nbsp;\n\n# Data\nUnfortunately data for constructing Figure 3 was not provided along with the published paper.^[The supplement with the published paper only included the age estimates data.] Thus, I simulated similar data using my `FSAsim` package. Given that `FSAsim` is a work-in-progress I don't show the code for simulating the data. However, the data can be downloaded as a CSV file [from here](Quistetal2022_SimBC.csv).\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\nThe resultant `df` data frame has the following four variables:\n\n- `strux`: Identifies the structure used to assign age (sectioned `otoliths` or `scales`), or whether the data are `observed` lengths and ages.\n- `id`: Unique fish identifier (not used in this analysis).\n- `age`: Age-at-capture for `observed` data or an age back-calculated to for `otoliths` and `scales`.\n- `len`: Length-at-capture for `observed` data or a back-calculated length for `otoliths` and `scales`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nFSA::peek(df,n=10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|         strux  id age len\n#R|  1   otoliths   1   1 178\n#R|  80  otoliths  25   4 326\n#R|  159 otoliths  53   3 464\n#R|  239 otoliths  73   1 202\n#R|  319 otoliths  95   5 371\n#R|  398   scales  19   1 262\n#R|  478   scales  46   1 254\n#R|  558   scales  77   2 283\n#R|  637 observed  20   6 444\n#R|  717 observed 100   3 353\n```\n:::\n:::\n\n\n&nbsp;\n\n# Recreating Figure 3\nFigure 3 in @quistetal_2022 is a boxplot. `geom_boxplot()` in `ggplot2` requires that the x-axis variable be \"discrete\" (or categorical). Thus, a new variable, `fage`, is created that is a factored (i.e., categorical) version of `age`. Additionally, the order of `strux` is alphabetical by default, which is not the order plotted by @quistetal_2022. Thus, `strux` is modified below to set the order of the levels.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf <- df |>\n  mutate(fage=factor(age),\n         strux=factor(strux,levels=c(\"scales\",\"otoliths\",\"observed\")))\n```\n:::\n\n\nThe default use of `geom_boxplot()` gets us close to Figure 3 in @quistetal_2022.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=df,mapping=aes(x=fage,y=len,fill=strux)) +\n  geom_boxplot() +\n  scale_x_discrete(name=\"Age (yrs)\") +\n  scale_y_continuous(name=\"Length (mm)\",\n                     limits=c(0,600),breaks=seq(0,600,100),\n                     expand=expansion(mult=0)) +\n  theme_q()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/figure-3-init-1.png){fig-align='center' width=672}\n:::\n:::\n\n\nHowever, we need to adjust the colors used, remove the legend, narrow the boxes, put \"caps\" on the ends of the whiskers, and change the outliers to open circles.\n\nThe colors to be used are defined in the named vector `clrs` below. This will be given to `scale_fill_manual()` below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nclrs <- c(\"scales\"=\"white\",\"otoliths\"=\"gray80\",\"observed\"=\"gray40\")\n```\n:::\n\n\nThe width of the boxes is set in `boxwid` and the width of the \"caps\" on the whisker is set at 80% of this box width. The distance between adjacent boxes at the same age is controlled with `position=` with a function called `position_dodge()`. It was not clear to me what to set these values to but I settled on the following after a little back-and-forth tinkering.^[The dodge width should be larger than the box width so that the boxes don't touch.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nboxwid <- 0.4                       # box width\ncapwid <- 0.8*boxwid                # whisker cap width\nboxsep <- position_dodge(width=0.5) # dodge amount between boxes\n```\n:::\n\n\nThe use of `stat_boxplot()` below is a trick to put an \"error bar\" behind the boxplot, which gives the impression that the whiskers are \"capped\" (i.e., the error bar caps are in the same place that the whisker caps would be). The shape^[\"21\" means a circle that has both a boundary and a fill color.], boundary color, and fill for the outlier marks are defined with `outlier.shape=`, `outlier.color=`, and `outlier.fill=`, respectively. Finally, `show.legend=FALSE` in `geom_boxplot()` is used to remove the legend.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=df,mapping=aes(x=fage,y=len,fill=strux)) +\n  stat_boxplot(geom=\"errorbar\",width=capwid,position=boxsep) +\n  geom_boxplot(width=boxwid,position=boxsep,\n               outlier.shape=21,outlier.color=\"black\",outlier.fill=\"white\",\n               show.legend=FALSE) +\n  scale_fill_manual(values=clrs) +\n  scale_x_discrete(name=\"Age (yrs)\") +\n  scale_y_continuous(name=\"Length (mm)\",\n                     limits=c(0,600),breaks=seq(0,600,100),\n                     expand=expansion(mult=0)) +\n  theme_q()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/figure-3-1.png){fig-align='center' width=576}\n:::\n:::\n\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}