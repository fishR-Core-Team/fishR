{
  "hash": "a4d9a1c67a9391f37ea19551e6ad6825",
  "result": {
    "markdown": "---\ntitle: Nested X-Axis Labels\ndescription: Creating nested labels for the x-axis in ggplot2.\nauthor: Derek H. Ogle\ndate: 3/30/2023\nimage: preview.png\ncategories:\n  - ggplot2\n  - axes\n---\n\n\n# Introduction\nRecently a Twitter follower asked ...\n\n> Any thought on easy ways to add a second x axis? Ex: sampling periods (sequential) on x axis and reviewer asking for the correspoding year as an additional axis under/over primary axis. It appears...hard to do.\n\nHere I explore a few different ways to do this.\n\nThe following packages are used here. Also note that a few functions from `FSA` and `scales` are used with `::` so that the entire package is not attached here.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # for ggplot2 and dplyr\nlibrary(ggh4x)      # for a variety of \"hacks\" described below\n```\n:::\n\n\n&nbsp;\n\n# Option 1 - Facets\n## Example 1 - Bar Chart\n### Sample Data\nSuppose you have very simple data where some numeric summary has been made for each group and that those groups are also categorized to a higher level. For example, total catch by species with species also categorized by family.^[Family is made a `factor()` here so that the order could be controlled (rather than alphabetical by default).]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ndat1 <- data.frame(family=c(\"Centrarchid\",\"Centrarchid\",\"Percid\",\"Percid\",\"Esocid\"),\n                   species=c(\"Bluegill\",\"Pumpkinseed\",\"Walleye\",\"Sauger\",\"Muskellunge\"),\n                   catch=c(34,45,23,36,7)) |>\n  mutate(family=factor(family,levels=c(\"Centrarchid\",\"Percid\",\"Esocid\")))\ndat1\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|         family     species catch\n#R|  1 Centrarchid    Bluegill    34\n#R|  2 Centrarchid Pumpkinseed    45\n#R|  3      Percid     Walleye    23\n#R|  4      Percid      Sauger    36\n#R|  5      Esocid Muskellunge     7\n```\n:::\n:::\n\n\nA simple bar chart of these data is created with `geom_col()` with `species` mapped to the x-axis and `catch` mapped to the y-axis. Here I provided a title for the y-axis, removed the lower expansion and reduce the upper expansion of the y-axis, applied the classic theme, increased the size of the axis title and tick mark text, made the axis titles bold, made the tick mark text black, and removed the x-axis title.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-fig-base-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nWhat the Twitter follower would want in this case is another layer of x-axis labels that would succinctly identify the family for each species.\n\n### Specifying Facets\nFaceting provides one option for applying these labels. Below I added one row of facets based on the family name with `facet_grid()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  facet_grid(cols=vars(family)) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-facet-1-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThis does not look immediately helpful!! However, adding `scales=\"free_x\"` to `facet_grid()` reduces each x-axis to only the species present in that facet (i.e., family).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  facet_grid(cols=vars(family),scales=\"free_x\") +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-facet-2-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nAdding `space=free_x` to `facet_grid()` ensures that the \"bars\" in each facet are the same width by adjusting the facet width to match the space needed to show just the data for that facet.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  facet_grid(cols=vars(family),scales=\"free_x\",space=\"free_x\") +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-facet-3-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nFinally, adding `switch=\"x\"` to `facet_grid()` moves the facet strip labels to the bottom of the plot area for each facet.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  facet_grid(cols=vars(family),scales=\"free_x\",space=\"free_x\",switch=\"x\") +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-facet-4-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThe next step is to move the facet strip labels \"outside\"^[Rather than the default \"inside\".] the axis tick mark labels with `strip.placement='outside'` in `theme()`. The facet strip \"box\" was also removed with `strip.background.x=` and the facet strip text was altered with `strip.text=`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  facet_grid(cols=vars(family),scales=\"free_x\",space=\"free_x\",switch=\"x\") +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        strip.placement='outside',\n        strip.background.x=element_blank(),\n        strip.text=element_text(size=12,color=\"black\",face=\"bold\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-facet-5-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nFinally, facets were \"smushed\" together so that the x-axis looks continuous by reducing `panel.spacing.x=` to 0.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  facet_grid(cols=vars(family),scales=\"free_x\",space=\"free_x\",switch=\"x\") +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        strip.placement='outside',\n        strip.background.x=element_blank(),\n        strip.text=element_text(size=12,color=\"black\",face=\"bold\"),\n        panel.spacing.x=unit(0,\"pt\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-facet-6-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThe family categorization could be further highlighted with a `fill=` color mapped to `family`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch,fill=family)) +\n  geom_col(color=\"black\") +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  scale_fill_grey(start=0.1,end=0.5) +\n  facet_grid(cols=vars(family),scales=\"free_x\",space=\"free_x\",switch=\"x\") +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        strip.placement='outside',\n        strip.background.x=element_blank(),\n        strip.text=element_text(size=12,color=\"black\",face=\"bold\"),\n        panel.spacing.x=unit(0,\"pt\"),\n        legend.position=\"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-facet-6-add-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n:::{.callout-important}\n## Open Question\nI could not, using this method, figure out how to reduce the inter-facet gap between bars so that it matched the intra-facet gap between bars.\n:::\n\n## Example 2 - Bar Chart with Dates\nThe Twitter follower's questions was about dates. So, imagine data that is the total catch of a species from the second(ish) week of each month over a few year period.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ndat2 <- data.frame(sample_date=seq(as.Date(\"2020-8-12\"),\n                                   as.Date(\"2022-4-7\"),by=\"month\")) |>\n  mutate(sample_date=sample_date-sample((-5:5),length(sample_date),replace=TRUE),\n         catch=round(runif(length(sample_date),50,150)))\n\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     sample_date catch\n#R|  1   2020-08-14    73\n#R|  2   2020-09-15   110\n#R|  3   2020-10-15   149\n#R|  18  2022-01-14   131\n#R|  19  2022-02-07    83\n#R|  20  2022-03-10    54\n```\n:::\n:::\n\n\nNow extract the month and year from the sample dates.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 <- dat2 |>\n  mutate(mon=month(sample_date,label=TRUE),\n         yr=year(sample_date))\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     sample_date catch mon   yr\n#R|  1   2020-08-14    73 Aug 2020\n#R|  2   2020-09-15   110 Sep 2020\n#R|  3   2020-10-15   149 Oct 2020\n#R|  18  2022-01-14   131 Jan 2022\n#R|  19  2022-02-07    83 Feb 2022\n#R|  20  2022-03-10    54 Mar 2022\n```\n:::\n:::\n\n\nA plot using the faceting method is created below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=mon,y=catch,fill=factor(yr))) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.25))) +\n  scale_fill_viridis_d(begin=0.1,end=0.5) +\n  facet_grid(cols=vars(yr),space='free_x',scales='free_x',switch='x') +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        strip.placement='outside',\n        strip.background.x=element_blank(),\n        strip.text=element_text(size=12,color=\"black\",face=\"bold\"),\n        panel.spacing.x=unit(0,\"pt\"),\n        legend.position=\"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat2-facet-1-1.png){fig-align='center' width=624}\n:::\n:::\n\n\n&nbsp;\n\n# Option 2 - ggh4x\n## Example 1 - Bar Chart\nThe `ggh4x` package provides `guide_axis_nested()` and related helpers for creating the secondary x-axis. This function, however, is predicated on plotting the *interaction* between the variables that defined the primary and secondary labels on the x-axis. An \"interaction\" is created with `interaction()` with, for these purposes, the nested variable listed second. For further below it is important to note that the parts of the interactions are separated by a single dot/period.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat1 <- dat1 |>\n  mutate(sfint=interaction(species,family))\ndat1\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|         family     species catch                   sfint\n#R|  1 Centrarchid    Bluegill    34    Bluegill.Centrarchid\n#R|  2 Centrarchid Pumpkinseed    45 Pumpkinseed.Centrarchid\n#R|  3      Percid     Walleye    23          Walleye.Percid\n#R|  4      Percid      Sauger    36           Sauger.Percid\n#R|  5      Esocid Muskellunge     7      Muskellunge.Esocid\n```\n:::\n:::\n\n\nThe basic bar chart from above is modified by mapping this interaction variable, rather than `species`, to the x-axis.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=sfint,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-fig-base-with-interaction-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThe parts of the interactions can be disentangled and turned into nested axes by setting `guide_axis_nested()` equal to `guide=` in `scale_x_discrete()`. Note that `delim=\".\"` is used in `guide_axis_nested()` because the parts of the interaction were separated with a single dot/period.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=sfint,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  scale_x_discrete(guide=guide_axis_nested(delim=\".\")) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-ggh4x-1-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThe primary tick mark labels are controlled with `axis.text.x=` which inherits from `axis.text=` if not given. Thus, the \"species\" labels are 10 pt black as defined above. The secondary tick mark labels inherit from `axis.text.x=` unless modifications are made in `ggh4x.axis.nesttext.x=` using `element_text()`. Below the \"family\" labels are set to 12 pt bold text.^[And will be black because `axis.text=` was set to black.] Finally, the line that separates the levels of labels is controlled with `element_line()` in `ggh4x.axis.nestline.x=`. The line is made slightly heavier below for illustration.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=sfint,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  scale_x_discrete(guide=guide_axis_nested(delim=\".\")) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        ggh4x.axis.nesttext.x=element_text(size=12,face=\"bold\"),\n        ggh4x.axis.nestline.x=element_line(linewidth=0.75))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-ggh4x-2-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n:::{.callout-important}\n## Open Question\nI could not, using this method, figure out how to make the line between the two levels of labels longer. For example, I would prefer the \"Centrarchid\" line to extend further right to more completely cover \"Pumpkinseed.\"\n:::\n\n## Example 2 -- Bar Chart with Dates\nThe data frame used for Option 1 must be modified to include the interaction between the `mon` and `yr` for use with `ggh4x`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 <- dat2 |>\n  mutate(myint=interaction(mon,yr))\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     sample_date catch mon   yr    myint\n#R|  1   2020-08-14    73 Aug 2020 Aug.2020\n#R|  2   2020-09-15   110 Sep 2020 Sep.2020\n#R|  3   2020-10-15   149 Oct 2020 Oct.2020\n#R|  18  2022-01-14   131 Jan 2022 Jan.2022\n#R|  19  2022-02-07    83 Feb 2022 Feb.2022\n#R|  20  2022-03-10    54 Mar 2022 Mar.2022\n```\n:::\n:::\n\n\nA plot using `ggh4x` is created below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=myint,y=catch,fill=factor(yr))) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.25))) +\n  scale_fill_viridis_d(begin=0.1,end=0.5) +\n  scale_x_discrete(guide=guide_axis_nested(delim=\".\")) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        ggh4x.axis.nesttext.x=element_text(size=12,face=\"bold\"),\n        ggh4x.axis.nestline.x=element_line(linewidth=0.75),\n        legend.position=\"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat2-ggh4x-1-1.png){fig-align='center' width=624}\n:::\n:::\n\n\n&nbsp;\n\n# Option 3 - Manual Placement\n## Example 1 - Bar Chart\nA third options is to create space below the x-axis and \"place\" the secondary axis \"manually.\" Before creating this space it is important to order primary axis labels so that categories to be grouped by the secondary level are next to each other. In this example, the species variable must be converted to a factor with the levels controlled so that families are grouped together.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat1 <- dat1 |>\n  mutate(species=factor(species,levels=c(\"Bluegill\",\"Pumpkinseed\",\n                                         \"Walleye\",\"Sauger\",\n                                         \"Muskellunge\")))\n```\n:::\n\n\nSpace below the x-axis is created by increasing the `b`ottom margin around the plot with `plot.margin=` in `theme()`. Below the bottom margin was increased to two \"lines\" and the other margins were set to one \"line\".^[The top, left, and right margins are defined by `t=`, `l=` and `r=` in `margin()`.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        plot.margin=margin(b=2,t=1,l=1,r=1,unit=\"lines\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-manual-1-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nPlot \"clipping\" must be turned off with `clip=\"off\"` in `coord_caresian()` to be able to place \"objects\" in the space just created.^[Because that space is outside of the main plot area.] In addition, the y-axis limits should be set with `ylim=` in `coord_cartesian()` so that the y-axis limits do not change as labels are added beneath the x-axis. As a demonstration, I placed my name at the x=1.5 and y=-5 coordinate.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        plot.margin=margin(b=2,t=1,l=1,r=1,unit=\"lines\")) +\n  coord_cartesian(ylim=c(0,NA),clip=\"off\") +\n  annotate(geom=\"text\",x=1.5,y=-5,label=\"Derek\",color=\"red\",fontface=\"bold\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-manual-2-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nChoosing a value for the y-coordinate beneath the axis is largely a matter of trial-and-error after an initial first guess. The x-coordinate, though, can largely be determined from the x-axis. The levels for a factor such as `species` are recorded as integers \"behind-the-scenes.\" In this example, a \"Bluegill\" is defined with a \"1\" as it is the first level and its bar will be above an invisible \"1\" on the x-axis. Thus, placing my name at x=1.5 centers it between the first and second bars.\n\nHere I want to create a secondary axis similar to what `ggh4x` produced -- a line segment with a label underneath it. The first segment for the secondary axis should cover \"Bluegill\" and \"Pumpkinseed.\" Thus, it should start a little below 1 and end a little above 2. Other segments are defined similarly and stored in a data frame below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nx2lns <- data.frame(xstart=c(0.55,2.55,4.55),\n                    xend=c(2.45,4.45,5.45))\nx2lns\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    xstart xend\n#R|  1   0.55 2.45\n#R|  2   2.55 4.45\n#R|  3   4.55 5.45\n```\n:::\n:::\n\n\nAt first, I roughly guess at starting and ending points and then come back to adjust these values if the lines need to be extended or shortened to look good. These segments are added to the plot with `geom_segment()` using this new data frame with the variables mapped appropriately. I set `y=` and `yend=` outside of `aes()` as the y-coordinate is constant for all these segments. Finally, the segment was made slightly heavier.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        plot.margin=margin(b=2,t=1,l=1,r=1,unit=\"lines\")) +\n  coord_cartesian(ylim=c(0,NA),clip=\"off\") +\n  geom_segment(data=x2lns,mapping=aes(x=xstart,xend=xend),y=-5,yend=-5,\n               linewidth=0.75)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-manual-3-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nOnce the segments are set as desired, another data frame is created that has the x-axis coordinate and text for the secondary axis label. Below, the coordinate was found by averaging `xstart` and `xend` for each segment in `x2lns`.^[This x coordinates in this data frame could have been entered manually, but computing the average makes it easier to put the label in the center of the segment.] The text for the labels was then entered manually.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nx2lbls <- x2lns |>\n  rowwise() |>\n  summarize(x=mean(c(xstart,xend))) |>\n  ungroup() |>\n  mutate(lbl=c(\"Centrarchid\",\"Percid\",\"Esocid\"))\nx2lbls\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 3 × 2\n#R|        x lbl        \n#R|    <dbl> <chr>      \n#R|  1   1.5 Centrarchid\n#R|  2   3.5 Percid     \n#R|  3   5   Esocid\n```\n:::\n:::\n\n\nThese labels are then added with `geom_text()` using the new data frame with the variables mapped appropriately. Again, `y=` was set outside of `aes()` as this coordinate is constant for all labels. The text was adjusted to be a 12 pt bold.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat1,mapping=aes(x=species,y=catch)) +\n  geom_col() +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=c(0,0.025))) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        plot.margin=margin(b=2,t=1,l=1,r=1,unit=\"lines\")) +\n  coord_cartesian(ylim=c(0,NA),clip=\"off\") +\n  geom_segment(data=x2lns,mapping=aes(x=xstart,xend=xend),y=-5,yend=-5,\n               linewidth=0.75) +\n  geom_text(data=x2lbls,mapping=aes(x=x,label=lbl),y=-8,\n            size=12/.pt,fontface=\"bold\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat1-manual-4-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n:::{.callout-important}\nChoosing how much to increase the bottom margin and choosing the x- and y-coordinates for the secondary x-axis labels with this method is largely a matter of trial-and-error.\n:::\n\n## Example 3 - Line Plot\nOptions 1 and 2 cannot handle situations where the plot is not \"discrete.\"^[At least, I could not make them work for these situations.] For example, suppose that a line plot of total catch in `dat2` by *sample date* (rather than month) is desired.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=sample_date,y=catch)) +\n  geom_line(linewidth=1) +\n  scale_x_date(breaks=scales::breaks_width(\"month\"),\n               labels=scales::label_date(\"%b %y\"),expand=expansion(mult=0.01)) +\n  scale_y_continuous(name=\"Total catch\",limits=c(0,200),expand=expansion(mult=0)) +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat2-line-1-1.png){fig-align='center' width=624}\n:::\n:::\n\n\nHowever, the x-axis is cluttered and suppose that a reviewer wants the months shown on the x-axis ticks with years as a secondary axis below that. The methods from above may be tried, but faceting clearly does not work (see below) and I could not get the `ggh4x` method to work with `scale_x_date()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=sample_date,y=catch)) +\n  geom_line(linewidth=1) +\n  scale_x_date(breaks=scales::breaks_width(\"month\"),\n               labels=scales::label_date(\"%b\"),expand=expansion(mult=0.01)) +\n  scale_y_continuous(name=\"Total catch\",limits=c(0,200),expand=expansion(mult=0)) +\n  facet_grid(cols=vars(yr),space='free_x',scales='free_x',switch='x') +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        strip.placement='outside',\n        strip.background.x=element_blank(),\n        strip.text=element_text(size=12,color=\"black\",face=\"bold\"),\n        panel.spacing.x=unit(0,\"pt\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat2-line-2-1.png){fig-align='center' width=624}\n:::\n:::\n\n\nOption 3, however, will work for situations like this. For this example, segments should \"cover\" Sep-Dec for 2021, Jan-Dec for 2022, and Jan-Mar for 2023. Starting (in `xstart`) and ending (in `xend`) dates for these segments are put in a data frame below. A data frame of labels is then constructed from it similar to before, except that the label is the year extracted from the x-coordinate date.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nx2lns <- data.frame(xstart=as.Date(c(\"20-Aug-2020\",\"20-Dec-2020\",\"20-Dec-2021\"),\n                                   format=\"%d-%B-%Y\"),\n                    xend=as.Date(c(\"15-Dec-2020\",\"15-Dec-2021\",\"15-Mar-2022\"),\n                                 format=\"%d-%B-%Y\"))\n\nx2lbls <- x2lns |>\n  rowwise() |>\n  summarize(x=mean(c(xstart,xend))) |>\n  ungroup() |>\n  mutate(lbl=year(x))\n```\n:::\n\n\nSegments and labels are then added as before.^[Note the use of `coord_cartesian()`, `geom_segment()`, `geom_text()`, and `plot.margin=`.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=sample_date,y=catch)) +\n  geom_line(linewidth=1) +\n  scale_x_date(breaks=scales::breaks_width(\"month\"),\n               labels=scales::label_date(\"%b\"),expand=expansion(mult=0.01)) +\n  scale_y_continuous(name=\"Total catch\",expand=expansion(mult=0)) +\n  coord_cartesian(ylim=c(0,200),clip=\"off\") +\n  theme_classic() +\n  theme(axis.title=element_text(size=12,face=\"bold\"),\n        axis.title.x=element_blank(),\n        axis.text=element_text(size=10,color=\"black\"),\n        plot.margin=margin(t=1,l=1,b=2,r=1,unit=\"lines\")) +\n  geom_segment(data=x2lns,mapping=aes(x=xstart,xend=xend),y=-18,yend=-18,\n               linewidth=0.75) +\n  geom_text(data=x2lbls,mapping=aes(x=x,label=lbl),y=-26,\n            size=12/.pt,fontface=\"bold\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/dat2-line-manual-1-1.png){fig-align='center' width=624}\n:::\n:::\n\n\n## Example 4 - Histogram\nIn this example, I use data on female Walleye captured from location \"2\" in Lake Erie in 2010.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ndata(WalleyeErie2,package=\"FSAdata\")\nwaedat <- WalleyeErie2 |>\n  filter(loc==2,year==2010,sex==\"female\")\nFSA::headtail(waedat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|        setID loc grid year  tl    w    sex    mat age\n#R|  1   2010019   2 1005 2010 642 3138 female mature   7\n#R|  2   2010019   2 1005 2010 686 3360 female mature   7\n#R|  3   2010019   2 1005 2010 685 3489 female mature  11\n#R|  919 2010058   2 1230 2010 715 4169 female mature  10\n#R|  920 2010058   2 1230 2010 549 1853 female mature   3\n#R|  921 2010058   2 1230 2010 596 2432 female mature   7\n```\n:::\n:::\n\n\nSuppose we want to make a simple length frequency histogram like that below,^[See [this post](../2019-12-28_Length_Frequency_Histograms/) about making length frequency histograms in `ggplot2`.] but with Gabelhouse length categories (\"stock\", \"quality\", etc.) listed below the lengths but above the title on the x-axis.^[There are probably better ways to create these labels, but this works as a demonstration of the secondary x-axis.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=waedat,mapping=aes(x=tl)) +\n  geom_histogram(binwidth=10,boundary=0,closed=\"left\",\n                 color=\"black\",fill=\"gray50\") +\n  scale_y_continuous(name=\"Frequency\",expand=expansion(mult=c(0,0.025))) +\n  scale_x_continuous(name=\"Total Length (mm)\",breaks=scales::breaks_width(50)) +\n  theme_bw() +\n  theme(axis.text=element_text(color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/wae-hist-1-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThe values for the Gabelhouse length categories are obtained from `psdVal()` in `FSA`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n( waepsd <- FSA::psdVal(\"Walleye\",incl.zero=FALSE) )\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      stock   quality preferred memorable    trophy \n#R|        250       380       510       630       760\n```\n:::\n:::\n\n\nThese values are used to make the endpoints of the segment lines, noting that each stops 2 mm before the next segment starts so as to provide a visible break in the segments. A data frame of labels was created as above, except that the text for the labels came from the names provided with `psdVal()`. Also note that 810 (i.e., the end of the x-axis) was appended to the segment ends so that the \"trophy\" segment would have an end point.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nx2lns <- data.frame(xstart=waepsd,xend=c(waepsd[-1]-2,810))\nx2lns\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|            xstart xend\n#R|  stock        250  378\n#R|  quality      380  508\n#R|  preferred    510  628\n#R|  memorable    630  758\n#R|  trophy       760  810\n```\n:::\n\n```{.r .cell-code}\nx2lbls <- x2lns |>\n  rowwise() |>\n  summarize(x=mean(c(xstart,xend))) |>\n  ungroup() |>\n  mutate(lbl=names(waepsd))\nx2lbls\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 5 × 2\n#R|        x lbl      \n#R|    <dbl> <chr>    \n#R|  1   314 stock    \n#R|  2   444 quality  \n#R|  3   569 preferred\n#R|  4   694 memorable\n#R|  5   785 trophy\n```\n:::\n:::\n\n\nMaking room for the secondary labels is a little different here because the x-axis title is maintained. Thus, instead of changing `plot.margin()` as above, more space is added by increasing the top margin of the x-axis title with `axis.title.x=`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=waedat,mapping=aes(x=tl)) +\n  geom_histogram(binwidth=10,boundary=0,closed=\"left\",\n                 color=\"black\",fill=\"gray50\") +\n  scale_y_continuous(name=\"Frequency\",expand=expansion(mult=c(0,0.025))) +\n  scale_x_continuous(name=\"Total Length (mm)\",breaks=scales::breaks_width(50),\n                     expand=expansion(mult=0.025)) +\n  theme_bw() +\n  theme(axis.text=element_text(color=\"black\"),\n        axis.title.x=element_text(margin=margin(t=3,unit=\"lines\")))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/wae-hist-2-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nThis space is then filled with the secondary axis labels as before.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=waedat,mapping=aes(x=tl)) +\n  geom_histogram(binwidth=10,boundary=0,closed=\"left\",\n                 color=\"black\",fill=\"gray50\") +\n  scale_y_continuous(name=\"Frequency\",expand=expansion(mult=c(0,0.025))) +\n  scale_x_continuous(name=\"Total Length (mm)\",breaks=scales::breaks_width(50),\n                     expand=expansion(mult=0.025)) +\n  theme_bw() +\n  theme(axis.text=element_text(color=\"black\"),\n        axis.title.x=element_text(margin=margin(t=3,unit=\"lines\"))) +\n  coord_cartesian(xlim=c(250,800),clip=\"off\") +\n  geom_segment(data=x2lns,mapping=aes(x=xstart,xend=xend),y=-7,yend=-7,\n               linewidth=0.75) +\n  geom_text(data=x2lbls,mapping=aes(x=x,label=lbl),y=-10,\n            size=11/.pt)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/wae-hist-3-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n# Further Thoughts\nOption 3 provides a great deal of flexibility. For example, suppose for the length frequency histogram that the segments are separated with vertical lines rather than breaks. To accomplish this, the 2 mm spacing in the segments data frame must be removed.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nx2lns <- data.frame(xstart=waepsd,xend=c(waepsd[-1],810))\n\nx2lbls <- x2lns |>\n  rowwise() |>\n  summarize(x=mean(c(xstart,xend))) |>\n  ungroup() |>\n  mutate(lbl=names(waepsd))\n```\n:::\n\n\nThen, for the segments, arrows are added at the beginning, but with a 90<sup>o</sup> angle so that they look like vertical lines.^[\"Arrows\" only at the beginning of the segments will make the last \"trophy\" segment appear open-ended, as it should.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=waedat,mapping=aes(x=tl)) +\n  geom_histogram(binwidth=10,boundary=0,closed=\"left\",\n                 color=\"black\",fill=\"gray50\") +\n  scale_y_continuous(name=\"Frequency\",expand=expansion(mult=c(0,0.025))) +\n  scale_x_continuous(name=\"Total Length (mm)\",breaks=scales::breaks_width(50),\n                     expand=expansion(mult=0.025)) +\n  theme_bw() +\n  theme(axis.text=element_text(color=\"black\"),\n        axis.title.x=element_text(margin=margin(t=3,unit=\"lines\"))) +\n  coord_cartesian(xlim=c(250,800),clip=\"off\") +\n  geom_segment(data=x2lns,mapping=aes(x=xstart,xend=xend),y=-7,yend=-7,\n               linewidth=0.75,\n               arrow=arrow(ends=\"first\",type=\"closed\",angle=90,length=unit(4,\"pt\"))) +\n  geom_text(data=x2lbls,mapping=aes(x=x,label=lbl),y=-10,\n            size=11/.pt)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/wae-hist-4-1.png){fig-align='center' width=528}\n:::\n:::\n\n\nAs another example, `geom_rect()` with judicious choices for `ymin=` and `ymax=` can be used to provide more options for the secondary axis labels.^[Note here that `data=` and `mapping=` had to moved out of `ggplot()` and put into `geom_histogram()` for this to work.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_histogram(data=waedat,mapping=aes(x=tl),\n                 binwidth=10,boundary=0,closed=\"left\",\n                 color=\"black\",fill=\"gray50\") +\n  scale_y_continuous(name=\"Frequency\",expand=expansion(mult=c(0,0.025))) +\n  scale_x_continuous(name=\"Total Length (mm)\",breaks=scales::breaks_width(50),\n                     expand=expansion(mult=0.025)) +\n  theme_bw() +\n  theme(axis.text=element_text(color=\"black\"),\n        axis.title.x=element_text(margin=margin(t=3,unit=\"lines\"))) +\n  coord_cartesian(xlim=c(250,800),clip=\"off\") +\n  geom_rect(data=x2lns,mapping=aes(xmin=xstart,xmax=xend),ymin=-12,ymax=-6,\n               fill=\"gray70\",color=\"gray30\") +\n  geom_text(data=x2lbls,mapping=aes(x=x,label=lbl),y=-8.75,\n            size=11/.pt)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/wae-hist-5-1.png){fig-align='center' width=528}\n:::\n:::\n\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}