{
  "hash": "2fb07639f237697b31c46aea58f2e6b6",
  "result": {
    "markdown": "---\ntitle: Plots of Back-Calculated Lengths-At-Age\ndescription: Initial thoughts on displaying back-calculated lengths-at-age.\nauthor: Derek H. Ogle\ndate: 11/7/2017\nimage: preview.png\ncategories:\n  - Growth\n  - Back-calculation\n  - ggplot2\n---\n\n\n:::{.callout-note}\nThe following packages are loaded for use below. I also set the default `ggplot` theme to `theme_bw()` for a classic \"black-and-white\" plot (rather than the default plot with a gray background).\n:::\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(FSA)      # for filterD(), headtail()\nlibrary(dplyr)    # for select(), arrange(), mutate(), group_by(), et al.\nlibrary(nlme)     # for nlme()\nlibrary(ggplot2)\ntheme_set(theme_bw())\n```\n:::\n\n\n&nbsp;\n\n# Introduction\nOne reader commented on a past post via Twitter ...\n\n> Now that you solved the age-bias plot, how about the 'best' display of back-calculated length-at-age data, with VonB growth curve overlay?\n\nIn addition, I recently received a question related to the non-convergence of a hierarchical (mixed) model applied to fitting a von Bertalanffy growth function (VBGF) to back-calculated lengths at age. In exploring that question, I realized that a \"good\" plot of back-calculated lengths-at-age was needed to understand why the VBGF may (or may not) fit.\n\nThis post represents my initial attempts to visualize back-calculated lengths at age with what are basically spaghetti plots. Spaghetti plots show individual longitudinal traces for each subject (e.g., [one example](https://blogs.sas.com/content/iml/2016/06/02/create-spaghetti-plots-in-sas.html)). Recently \"spaghetti plots\" were in the news to show modeled paths of hurricanes (e.g., [I particularly enjoyed this critique](https://arstechnica.com/science/2017/09/please-please-stop-sharing-spaghetti-plots-of-hurricane-models/)).\n\n&nbsp;\n\n# Data\nIn this post, I examine back-calculated lengths (mm) at age for Walleye (*Sander vitreus*) captured from Lake Mille Lacs, Minnesota in late fall (September-October).^[More details [are here](http://derekogle.com/fishR/data/data-html/WalleyeML.html).] These data were kindly provided by the Minnesota Department of Natural Resources, are available in `FSAData`, and were used extensively in @ogle_growth_2017. For simplicity of presentation here, these data were reduced (with `filter()`) to a single year and sex, several unneeded variables were removed (with `select()`, a new factored version of the estimated age variable was created (with `mutate()`), and the data were ordered by estimated, fish identification number, and back-calculated age.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Get data\ndata(WalleyeML,package=\"FSAdata\")\n## Wrangle data\ndf <- WalleyeML |>\n  filter(Year==2002,Sex==\"F\") |>\n  select(-Year,-Sex,-Scale.Rad,-Dist.Ann) |>\n  mutate(fEst.Age=factor(Est.Age)) |>\n  arrange(Est.Age,ID,BC.Age)\n## Examine results\nheadtail(df,n=5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|                 ID Est.Age  TL BC.Age BC.Len fEst.Age\n#R|  1    2002.10416.F       1 232      1  81.21        1\n#R|  2    2002.10493.F       1 248      1 114.60        1\n#R|  3    2002.10606.F       1 287      1 112.21        1\n#R|  4     2002.1153.F       1 273      1 116.29        1\n#R|  5     2002.1154.F       1 244      1 157.55        1\n#R|  1864 2002.20742.F      10 592      6 523.52       10\n#R|  1865 2002.20742.F      10 592      7 539.77       10\n#R|  1866 2002.20742.F      10 592      8 554.83       10\n#R|  1867 2002.20742.F      10 592      9 567.56       10\n#R|  1868 2002.20742.F      10 592     10 576.20       10\n```\n:::\n:::\n\n\nThese fish were captured in late fall such that the observed length includes current year's growth. However, the observed age does not account for time since the fish's \"birthday.\" In other words, the observed age at capture should be a \"fractional age\" such that it represents completed years of growth plus the fraction of the current year's growth season completed (i.e., the \"current age\" should be something like 10.9 rather than 10). An example of this is seen by comparing the observed length at capture (in `TL`) and the back-calculated length (in `BC.Len`) to age-1 for the first fish in the data.frame (first line in data shown above).\n\nSome of the plots below require a data frame where the length and age for the oldest age match in time. In other words, this data.frame should contain the length of the fish on the fish's last \"birthday.\" With these data, that length is the back-calculated length at the age (in `BC.Age`) that matches the age of the fish at the time of capture (in `Est.Age`).^[With other data, that length may simply be the length of the fish at the time of capture.] An example of this data frame is below (especially compare the last five lines below to the last five lines in the previous data frame snippet above).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# data.frame of just lengths at last full age\ndf2 <- df |>\n  filter(BC.Age==Est.Age)\nheadtail(df2,n=5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|                ID Est.Age  TL BC.Age BC.Len fEst.Age\n#R|  1   2002.10416.F       1 232      1  81.21        1\n#R|  2   2002.10493.F       1 248      1 114.60        1\n#R|  3   2002.10606.F       1 287      1 112.21        1\n#R|  4    2002.1153.F       1 273      1 116.29        1\n#R|  5    2002.1154.F       1 244      1 157.55        1\n#R|  311 2002.20381.F      10 568     10 563.73       10\n#R|  312 2002.20483.F      10 594     10 580.81       10\n#R|  313 2002.20511.F      10 628     10 618.89       10\n#R|  314 2002.20688.F      10 620     10 611.08       10\n#R|  315 2002.20742.F      10 592     10 576.20       10\n```\n:::\n:::\n\n\nFinally, in some plots below the mean back-calculated length at age is included.^[`as.data.frame()` removes the `tibble` class and the remaining grouping level from this data frame.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# data.frame of mean lengths at back-calculated ages\ndf3 <- df |>\n  group_by(fEst.Age,BC.Age) |>\n  summarize(mnBC.Len=mean(BC.Len)) |>\n  as.data.frame()\nheadtail(df3,n=5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|     fEst.Age BC.Age mnBC.Len\n#R|  1         1      1 111.3464\n#R|  2         2      1 113.4633\n#R|  3         2      2 225.3060\n#R|  4         3      1  98.5338\n#R|  5         3      2 211.4096\n#R|  51       10      6 505.5437\n#R|  52       10      7 538.0147\n#R|  53       10      8 558.6757\n#R|  54       10      9 571.4900\n#R|  55       10     10 579.8577\n```\n:::\n:::\n\n\n# Plots for Exploratory Data Analysis\nWhen modeling fish growth, I explore the data to make observations about (i) variability in length at each age and (ii) \"shape\" of growth (i.e., whether or not there is evidence for an horizontal asymptote or inflection point). When using repeated-measures data, for example from back-calculated lengths-at-age, I observe the \"shape\" of growth for each individual and (iii) identify how the back-calculated lengths at age from older fish compare to the back-calculated lengths at age from younger fish.^[As major differences could suggest [\"Lee's Phenomenon\"](http://www.fishbase.org/glossary/Glossary.php?q=Lee%C2%B4s+phenomenon), substantial changes in growth between year-classes or over time, or problems with the back-calculation model.] In this section, I describe two plots (with some augmentations to the first type) that could be useful during this exploratory stage. In the last section, I describe a plot that could be used for publication. \n\n&nbsp;\n\n@fig-SpaghettiPlot1 shows longitudinal traces of back-calculated lengths at age for each fish, with separate colors for fish with different observed ages at capture. From this I see variability of approximately 100 mm at each age, individual fish that generally follow the typical shape of a VBGF, and some evidence that back-calculated lengths at earlier ages from \"older\" fish at capture are somewhat lower than the back-calculated lengths at earlier ages for \"younger\" fish at capture (this is most evident with the pinkish lines).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsp <- ggplot(data=df,aes(x=BC.Age,y=BC.Len,color=fEst.Age,group=ID)) +\n  geom_line(alpha=1/8) +\n  scale_x_continuous(\"Back-Calculated Age\") +\n  scale_y_continuous(\"Back-Calculated Length (mm)\") +\n  theme(legend.position=\"none\")\nsp\n```\n\n::: {.cell-output-display}\n![Traces of back-calculated lengths at age for each fish. Traces with the same color are fish with the same observed age at capture.](index_files/figure-html/fig-SpaghettiPlot1-1.png){#fig-SpaghettiPlot1 fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n@fig-SpaghettiPlot2 is the same as @fig-SpaghettiPlot1 except that heavy lines have been added for the mean back-calculated lengths at age for fish from each age-at-capture. Here the evidence that back-calculated lengths at earlier ages from \"older\" fish at capture are somewhat lower than the back-calculated lengths at earlier ages for \"younger\" fish at capture is a little more obvious.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsp +\n  geom_line(data=df3,\n            aes(x=BC.Age,y=mnBC.Len,group=fEst.Age,color=fEst.Age))\n```\n\n::: {.cell-output-display}\n![Traces of back-calculated lengths at age for each fish with mean back-calculated lengths at age shown by the heavier lines. Traces with the same color are fish with the same observed age at capture.](index_files/figure-html/fig-SpaghettiPlot2-1.png){#fig-SpaghettiPlot2 fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n@fig-SpaghettiPlot3 is the same as @fig-SpaghettiPlot1 but also has points for the length and age of each fish at the last *completed* year of growth. These points are most near to the observed lengths and ages at capture^[They will be the observed lengths and ages at capture for datasets where the fish were captured prior to when the current season's growth had commenced.] and, thus, most nearly represent the data that would be used to fit a growth model if back-calculations had not been made. With this I observe that most traces of back-calculated lengths-at-age pass near these points, which suggests that \"growth\" has not changed dramatically over the time represented in these data and that the model used to back-calculate lengths and ages is not dramatically incorrect.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsp + \n  geom_point(data=df2,aes(color=fEst.Age),alpha=1/5)\n```\n\n::: {.cell-output-display}\n![Traces of back-calculated lengths at age for each fish. Traces with the same color are fish with the same observed age at capture.](index_files/figure-html/fig-SpaghettiPlot3-1.png){#fig-SpaghettiPlot3 fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\nThe previous plots are cluttered because of the number of individual fish. This clutter can be somewhat reduced by creating separate spaghetti plots for each observed age at capture (@fig-SpaghettiPlotSep). From this, I observe the clear start of an asymptote at about age 5, an indication of a slight inflection around age 2 (most evident for fish that were older at capture), and that a good portion of the variability in length at early ages may be attributable to fish from different year-classes (i.e., of different observed ages-at-capture). It is, however, more difficult to see that back-calculated lengths at earlier ages from \"older\" fish at capture are somewhat lower than the back-calculated lengths at earlier ages for \"younger\" fish at capture.^[I left the facet for age-1 fish in this plot to remind me that there were age-1 fish in these data, even though they do not show a trace. Also, the color here is superfluous and could be removed. I left the color here for comparison with previous figures.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Make facet labels for the plot below\nlbls <- paste(\"Age =\",levels(df$fEst.Age))\nnames(lbls) <- levels(df$fEst.Age)\n\n## Spaghetti plot separated by age at capture (with means)\nsp + \n  facet_wrap(~fEst.Age,labeller=labeller(fEst.Age=lbls)) +\n  geom_line(data=df3,aes(x=BC.Age,y=mnBC.Len,group=1),color=\"black\")\n```\n\n::: {.cell-output-display}\n![Traces of back-calculated lengths at age for each fish separated by observed age at capture. Black lines in each facet are the mean back-calculated lengths at age for fish shown in that facet.](index_files/figure-html/fig-SpaghettiPlotSep-1.png){#fig-SpaghettiPlotSep fig-align='center' width=480}\n:::\n:::\n\n\n&nbsp;\n\n# Publication Graphic with Model Overlaid\nFor publication I would include traces for individual fish, but without color coding by estimated age-at-capture, and overlay the population-average growth model (i.e., the growth model expressed from using the \"fixed effects\" for each model parameter; @fig-PubPlot).^[The model fitting code below is from @ogle_growth_2017.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## Create the Von B Function using logged version of Linf (to ease scale issue)\nvbT <- function(T,logLinf,K=NULL,t0=NULL) {\n  if (length(logLinf)==3) {\n    t0 <- logLinf[[3]]\n    K <- logLinf[[2]]\n    logLinf <- logLinf[[1]]\n  }\n  exp(logLinf)*(1-exp(-K*(T-t0)))\n}\n\n## Generate starting values from last completed length and age data\nvbStarts(BC.Len~BC.Age,data=df2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  $Linf\n#R|  [1] 624.3608\n#R|  \n#R|  $K\n#R|  [1] 0.2767802\n#R|  \n#R|  $t0\n#R|  [1] 0.2903228\n```\n:::\n\n```{.r .cell-code}\nsvVB <- list(fixed=c(logLinf=log(624.361),K=0.276,t0=0.290))\n\n## Fit hierarchical von B to back-calcd data (BE PATIENT)\n##   Will estimate population-average parameters (fixed-effect values)\n##   and parameters for each individual (in coefficients).\nfitVB <- nlme(BC.Len~vbT(BC.Age,logLinf,K,t0),data=df,\n              fixed=list(logLinf~1,K~1,t0~1),\n              random=logLinf+K+t0~1|ID,\n              start=svVB)\n```\n:::\n\n::: {.cell layout-align=\"center\" hash='index_cache/html/fig-PubPlot_bdb5bfde782ee8b9ead755511f1da36e'}\n\n```{.r .cell-code}\n## von B equation for the plot\n( tmp <- fixef(fitVB) )\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    logLinf         K        t0 \n#R|  6.4662516 0.2784915 0.3922489\n```\n:::\n\n```{.r .cell-code}\nlbl <- paste(\"L==\",round(exp(tmp[1]),0),\n             \"*bgroup('(',1-e^-\",round(tmp[2],3),\n             \"(Age-\",round(tmp[3],2),\"),')')\")\n\nggplot(data=df,aes(x=BC.Age,y=BC.Len,group=ID)) +\n  geom_line(alpha=1/15) +\n  stat_function(data=data.frame(T=seq(1,10,0.1)),aes(x=T,y=NULL,group=NULL),\n                fun=vbT,args=list(logLinf=fixef(fitVB)),linewidth=1.1) +\n  geom_text(data=data.frame(x=7,y=120),aes(x=x,y=y,group=NULL,\n                            label=lbl),parse=TRUE,size=4) +\n  scale_x_continuous(\"Back-Calculated Age\") +\n  scale_y_continuous(\"Back-Calculated Length (mm)\") +\n  theme(legend.position=\"none\")\n```\n\n::: {.cell-output-display}\n![Traces of back-calculated lengths at age for each fish (lighter black lines) with the population-averaged von Bertalanffy growth function (dark black line) overlaid. The equation for the best-fit von Bertalanffy growth function is shown.](index_files/figure-html/fig-PubPlot-1.png){#fig-PubPlot fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}