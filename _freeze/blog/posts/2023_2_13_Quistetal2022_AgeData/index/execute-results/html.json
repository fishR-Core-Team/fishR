{
  "hash": "805a4e86c2a176a119568abece5468e4",
  "result": {
    "markdown": "---\ntitle: Quist et al. (2022) Age Comparison Figures\ndescription: Using ggplot2 to recreate the age comparison figures in Quist et al. (2022).\nauthor: Derek H. Ogle\ndate: 2/13/2023\nimage: preview.png\ncategories:\n  - ggplot2\n  - Age Comparisons\n---\n\n\n# Introduction\n@quistetal_2022 examined three structures (scales, sectioned otoliths, and whole otoliths) to estimate age of Yellowstone Cutthroat Trout (*Oncorhynchus clarkii bouvieri*). Their published paper included a supplement with the data they used to estimate age precision and bias between readers and between structures.\n\nA [previous post](../2021-3-15-AgeBiasPlots/) demonstrated my preferred methods for displaying such data. Here, as I continue to hone my `ggplot2` skills, I did not follow my preferences but rather tried to recreate Figures 1 and 2 in @quistetal_2022. My process is described below.\n\n&nbsp;\n\n# Getting Setup\nThe following packages are loaded for use below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # for dplyr, ggplot2, stringr packages\nlibrary(patchwork)  # for positioning multiple plots\n```\n:::\n\n\nThe following `ggplot2` theme was used below.^[See [this post](../2022-12-22_AFS_Style_Figures/) for more information on creating and using `ggplot2` themes.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntheme_q <- function(base_size=14) {\n  theme_bw(base_size=base_size) +\n    theme(\n      # margin for the plot\n      plot.margin=unit(c(0.5,0.5,0.5,0.5),\"cm\"),\n      # set axis label (i.e., title) colors and margins\n      axis.title.y=element_text(colour=\"black\",margin=margin(t=0,r=10,b=0,l=0)),\n      axis.title.x=element_text(colour=\"black\",margin=margin(t=10,r=0,b=0,l=0)),\n      # set tick label color, margin, and position and orientation\n      axis.text.y=element_text(colour=\"black\",margin=margin(t=0,r=5,b=0,l=0),\n                               vjust=0.5,hjust=1),\n      axis.text.x=element_text(colour=\"black\",margin=margin(t=5,r=0,b=0,l=0),\n                               vjust=0,hjust=0.5,),\n      # set size of the tick marks for y- and x-axis\n      axis.ticks=element_line(linewidth=0.5),\n      # adjust length of the tick marks\n      axis.ticks.length=unit(0.2,\"cm\"),\n      # set the axis size,color,and end shape\n      axis.line=element_line(colour=\"black\",linewidth=0.5,lineend=\"square\"),\n      # adjust size of text for legend\n      legend.text=element_text(size=12),\n      # remove grid\n      panel.grid=element_blank()\n    )\n}\n```\n:::\n\n\n&nbsp;\n\n# Data\nI downloaded the Excel file provided as [a supplement to the published paper](https://meridian.allenpress.com/jfwm/article/13/2/544/483421/Comparison-of-Structures-Used-to-Estimate-Age-and#supplementary-data) to my local drive and named it \"quistetal_2022.xlsx\". The authors used \".\" for missing data which I addressed with `na=` in `read_excel()` below. The authors also recorded \"confidence\" values for each age assignment but those were not used in any analysis here so I removed them. Names for the remaining variables were long and somewhat inconsistent so I renamed those to be shorter and consistent.^[Note that `as.data.frame()` is used to remove the `tibble` class returned from `read_excel()` that I don't prefer.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf <- readxl::read_excel(\"quist_etal_2022.xlsx\",na=c(\"\",\".\")) |>\n  select(-contains(\"Confidence\")) |>\n  rename(scale_r1=`Reader_1_Scale_age`,\n         scale_r2=`Reader_2_Scale_age`,\n         scale_age=`Consensus_scale_age`,\n         soto_r1=`Reader_1_Sectioned_Otolith_age`,\n         soto_r2=`Reader_2_Sectioned_Otolith_age`,\n         soto_age=`Consensus_Sectioned_Otolith_Age`,\n         woto_r1=`Reader_1_Whole_Otolith_age`,\n         woto_r2=`Reader_2_Whole_Otolith_age`,\n         woto_age=`Consensus_Whole_Otolith`) |>\n  as.data.frame()\nhead(df)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    Length Year scale_r1 scale_r2 scale_age soto_r1 soto_r2 soto_age woto_r1\n#R|  1    168 2019        1        1         1       1       1        1      NA\n#R|  2    169 2019        1        1         1       1       1        1       1\n#R|  3    172 2019        1        2         1       2       1        1      NA\n#R|  4    175 2020        1        1         1       2       2        2       2\n#R|  5    178 2019        1        1         1       1       1        1       1\n#R|  6    216 2020        2        2         2       2       2        2      NA\n#R|    woto_r2 woto_age\n#R|  1      NA       NA\n#R|  2       1        1\n#R|  3      NA       NA\n#R|  4       1        1\n#R|  5       1        1\n#R|  6      NA       NA\n```\n:::\n:::\n\n\nFigures 1 and 2 in @quistetal_2022 each used axis labels that ranged from 0 to 12 and were only shown for even values. Those limits and labels are set here for ease and consistency below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naxlbls <- seq(0,12,2)\naxlmts <- range(axlbls)\n```\n:::\n\n\n&nbsp;\n\n# Plot One Structure\nI begin by showing how to create one panel (i.e., for estimate age between readers for one structure) of Figure 1.\n\nI first created a summary data frame that has the number of observations for each combination of age estimates by each reader. For example, there were three instances where each reader assigned an age of 1 and two instances where reader 1 assigned an age of 1 but reader 2 assigned and age of 2.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf_wo <- df |>\n  group_by(woto_r1,woto_r2) |>\n  summarize(freq=n()) |>\n  as.data.frame()\nhead(df_wo)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|    woto_r1 woto_r2 freq\n#R|  1       1       1    3\n#R|  2       1       2    2\n#R|  3       2       1    2\n#R|  4       2       2  114\n#R|  5       2       3   28\n#R|  6       2       4    1\n```\n:::\n:::\n\n\n`agePrecision()` from `FSA` was then used to compute a variety of age precision statistics between the two readers. For these purposes, note that exact percent agreement is returned in `$PercAgree` and the average coefficient of variation is returned in `$ACV` of the object saved from `agePrecision()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nap_wo <- FSA::agePrecision(woto_r2~woto_r1,data=df)\nstr(ap_wo)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  List of 14\n#R|   $ detail   :'data.frame':\t416 obs. of  12 variables:\n#R|    ..$ woto_r2: num [1:416] NA 1 NA 1 1 NA 2 2 1 2 ...\n#R|    ..$ woto_r1: num [1:416] NA 1 NA 2 1 NA 2 2 1 2 ...\n#R|    ..$ mean   : num [1:416] NA 1 NA 1.5 1 NA 2 2 1 2 ...\n#R|    ..$ median : num [1:416] NA 1 NA 1.5 1 NA 2 2 1 2 ...\n#R|    ..$ mode   : num [1:416] NA 1 NA NA 1 NA 2 2 1 2 ...\n#R|    ..$ SD     : num [1:416] NA 0 NA 0.707 0 ...\n#R|    ..$ CV     : num [1:416] NA 0 NA 47.1 0 ...\n#R|    ..$ CV2    : num [1:416] NA 0 NA 47.1 0 ...\n#R|    ..$ AD     : num [1:416] NA 0 NA 0.5 0 NA 0 0 0 0 ...\n#R|    ..$ PE     : num [1:416] NA 0 NA 33.3 0 ...\n#R|    ..$ PE2    : num [1:416] NA 0 NA 33.3 0 ...\n#R|    ..$ D      : num [1:416] NA 0 NA 33.3 0 ...\n#R|   $ rawdiff  : 'table' int [1:7(1d)] 2 36 248 82 6 0 1\n#R|    ..- attr(*, \"dimnames\")=List of 1\n#R|    .. ..$ : chr [1:7] \"-2\" \"-1\" \"0\" \"1\" ...\n#R|   $ absdiff  : 'table' int [1:5(1d)] 248 118 8 0 1\n#R|    ..- attr(*, \"dimnames\")=List of 1\n#R|    .. ..$ : chr [1:5] \"0\" \"1\" \"2\" \"3\" ...\n#R|   $ ASD      : num 0.26\n#R|   $ ACV      : num 7.81\n#R|   $ ACV2     : num 7.81\n#R|   $ AAD      : num 0.184\n#R|   $ APE      : num 5.52\n#R|   $ APE2     : num 5.52\n#R|   $ AD       : num 5.52\n#R|   $ PercAgree: num 66.1\n#R|   $ R        : int 2\n#R|   $ n        : int 416\n#R|   $ validn   : int 375\n#R|   - attr(*, \"class\")= chr \"agePrec\"\n```\n:::\n:::\n\n\n@quistetal_2022 also reported \"PA-1\" (i.e., the percent agreement within one age), which is not returned by `agePrecision()`. This value can, however, be calculated by summing the first two values in `$absDiff` (these are the counts of perfect agreement and agreement within one age) and dividing by the total number of paired assignments in `$validn`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsum(ap_wo$absdiff[1:2])/ap_wo$validn*100\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  [1] 97.6\n```\n:::\n:::\n\n\n@quistetal_2022 annotated their plots with these three summary values. Below I use `str_glue()` to concatenate together these values into a single string that will be added to the plots below. In the use of `str_glue()` below the three summary measures are assigned to objects named `PA`, `PA1`, and `CV` (*last three lines*) and those values are then inserted into the string (*first four lines*) within the `{}` delimiters. I also used `formatC()` is used to format the string to one decimal place and that `\\n` is a \"carriage return\" that starts a new line in the string.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlbl_wo <- str_glue(\"Whole Otoliths\\n\",\n                   \"PA = {PA}%\\n\",\n                   \"PA-1 = {PA1}%\\n\",\n                   \"CV = {CV}\",\n                   PA=formatC(ap_wo$PercAgree,format='f',digits=1),\n                   PA1=formatC(sum(ap_wo$absdiff[1:2])/ap_wo$validn*100,format='f',digits=1),\n                   CV=formatC(ap_wo$ACV,format='f',digits=1))\nlbl_wo\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Whole Otoliths\n#R|  PA = 66.1%\n#R|  PA-1 = 97.6%\n#R|  CV = 7.8\n```\n:::\n:::\n\n\nFinally, the plot is made by first^[So that it appears behind the numbers.] adding the 1:1 reference line with `geom_a line()`, the frequency of age estimates with `geom_label()`, and the summary results as text with `annotate()`. The arguments in `geom_label()` remove the rounded edges of the boxes (i.e., `label.r`) and attempt to make the boxes larger to more closely abut as in @quistetal_2022. The arguments in `annotate()` put the label at the minimum x and maximum y values, then vertically and horizontally adjust that text box so that the upper-left corner is just inside the upper-left corner of the plot. Finally, the expansion factors are removed from both axes and both axes are limited to and labeled with the limits and labels set above.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nrs_wo <- ggplot(data=df_wo,mapping=aes(x=woto_r1,y=woto_r2,label=freq)) +\n  geom_abline(slope=1,intercept=0) +\n  geom_label(label.r=unit(0,\"lines\"),label.padding=unit(0.3,\"lines\")) +\n  annotate(geom=\"text\",label=lbl_wo,\n           x=0,y=12,hjust=-0.1,vjust=1.1,size=4) +\n  scale_x_continuous(name=\"Reader 1\",expand=expansion(mult=0),\n                     limits=axlmts,breaks=axlbls) +\n  scale_y_continuous(name=\"Reader 2\",expand=expansion(mult=0),\n                     limits=axlmts,breaks=axlbls) +\n  theme_q()\nrs_wo\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/figure-rs_wo-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n&nbsp;\n\n:::{.callout-note}\n- I did not find a good way to make the boxes around each value the same size as in @quistetal_2022.\n- Also, I think that graphs with the same rnge of values on both axes should be presented as a square, rather than as the rectangle used by @quistetal_2022.\n:::\n\n&nbsp;\n\n# Recreating Figure 1\nThe code described above can largely be repeated for scales and sectioned otoliths, which I did without showing the code but saving the results in `ggplot2` objects called `rs_sc` and `rs_so`.\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\nHowever, when these two objects are combined together with `rs_wo` to form Figure 1, they should not have a title or labels for the x-axis. The x-axis title and labels are removed by setting `axis.title.x=` and `axis.text.x=` in `theme()` to `element_blank()` and appending this to each object.^[Note that each object is modified and then saved to the same name here.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nrs_so <- rs_so +\n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank())\nrs_sc <- rs_sc +\n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank())\n```\n:::\n\n\nFinally, the three plots can be stacked on top of each other using `patchwork` as shown below.^[Use smaller values in `plot.margin=` in `theme_q` to more closely resemble how close the panels are in @quistetal_2022.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nrs_sc + rs_so + rs_wo +\n  plot_layout(ncol=1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/figure1-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n&nbsp;\n\n# Recreating Figure 2\nFigure 2 would follow the same general process as Figure 1 except that the summary results annotation would only have the results and not a \"title\" and each panel in the figure would have the x-axis title and labels.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-html/figure2-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}