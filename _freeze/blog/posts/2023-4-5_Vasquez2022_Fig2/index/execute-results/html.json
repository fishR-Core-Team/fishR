{
  "hash": "b070b5452e899ec450c7780e68af8577",
  "result": {
    "markdown": "---\ntitle: Vasquez et al. (2022) Kuskal-Wallis Results\ndescription: Using ggplot2 to display results from Kruskal-Wallis test.\nauthor: Derek H. Ogle\ndate: 4/5/2023\nimage: preview.png\ncategories:\n  - ggplot2\n  - confidence intervals\n  - significance letters\n  - Kruskal-Wallis Test\n  - Dunn Test\n---\n\n\n# Introduction\n@vasquezetal_2022 examined the nesting materials of Black-Crested Titmice (*Baeolophus atricristatus*) near San Marcos, Texas. In one part of their analysis they used a Kruskal-Wallis test to identify differences in total nest weight for nests from four different area types (based on a rural to urban gradient). They summarized their results in Panel A of their [Figure 2](https://meridian.allenpress.com/view-large/figure/14538150/i1944-687X-13-1-236-f02.tif). Here I recreate their statistics, but summarize the results differently.\n\nThe following packages are loaded for use below. A few functions from each of `FSA`, `car`, `DescTools`, and `scales` are used with `::` such that the entire packages are not attached here.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # for dplyr, ggplot2 packages\n```\n:::\n\n\n&nbsp;\n\n# Data Wrangling\n@vasquezetal_2022 provided the raw data in their Data Supplement S1.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat <- read.csv(\"JFWM-21-058.S1.csv\")\nnames(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|   [1] \"Number\"            \"Location2\"         \"Location\"         \n#R|   [4] \"Nest.Weight.and.P\" \"Plastic.Weight\"    \"Nest.Weight\"      \n#R|   [7] \"Plastic\"           \"Cotton\"            \"Moss\"             \n#R|  [10] \"Twigs\"             \"Leaves\"            \"Snake.Skin\"       \n#R|  [13] \"Natural\"           \"Anthro\"            \"eggs.laid\"        \n#R|  [16] \"eggs.hatch\"        \"Date\"              \"Julian\"           \n#R|  [19] \"Beetle\"            \"First.Attempt\"     \"Second.Attempt\"   \n#R|  [22] \"X2nd.Clutch\"       \"Photo\"             \"p.plastic\"        \n#R|  [25] \"p.cotton\"          \"p.moss\"            \"p.twigs\"          \n#R|  [28] \"p.leaves\"          \"p.snake\"           \"p.art\"            \n#R|  [31] \"p.nat\"             \"total.prop\"\n```\n:::\n:::\n\n\nThere is both a `Location` and a `Location2` variable in this data frame, but neither contains text that exactly match the \"area types\" shown in @vasquezetal_2022.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nxtabs(~Location+Location2,data=dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|              Location2\n#R|  Location     Rural Semi Rural Semi Urban Urban\n#R|    ACampus        0          0          0     7\n#R|    BResidence     0          1         11     0\n#R|    CPark          0          5          0     0\n#R|    DFreeman      21          0          0     0\n```\n:::\n:::\n\n\nHowever, sample sizes for the `Location` variable groups match those in the paper. Therefore, I created `Location3` by mapping the names in `Location` to the names used in the paper. I also turned `Location3` into a factor to order the levels along the rural to urban gradient as @vasquezetal_2022 did. Finally, for this post, I only focus on the total weight of the nest, so I only retained `Nest.Weight` and `Location3` for further analysis.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndat2 <- dat |>\n  mutate(Location3=plyr::mapvalues(Location,\n                                   from=c(\"ACampus\",\"BResidence\",\"CPark\",\"DFreeman\"),\n                                   to=c(\"Urban\",\"Residential\",\"Parks\",\"Rural\")),\n         Location3=factor(Location3,levels=c(\"Rural\",\"Parks\",\"Residential\",\"Urban\"))) |>\n  select(Location3,Nest.Weight)\nFSA::headtail(dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|       Location3 Nest.Weight\n#R|  1        Urban        27.5\n#R|  2        Urban        31.8\n#R|  3        Urban        35.4\n#R|  43 Residential        65.8\n#R|  44 Residential        44.7\n#R|  45 Residential        43.7\n```\n:::\n:::\n\n\n# Kruskal-Wallis Test\n## Assumption Checking\n@vasquezetal_2022 chose to use a Kruskal-Wallis test^[I assume the reader is familiar with a Kruskal-Wallis Test. If not, [this](https://www.statology.org/kruskal-wallis-test/) is one resource that may be useful.] to determine if nest weights differed among area types because of concerns over normality and equal variances. They tested normality with a Shapiro-Wilk test, but this is difficult to do given the small sample sizes, especially in the \"Parks\" and \"Urban\" areas. Instead of the test I examined a density plot of total nest weight for each area type.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(x=Nest.Weight)) +\n  geom_density(linewidth=0.75) +\n  geom_rug(linewidth=0.75) +\n  scale_x_continuous(name=\"Nest Weight (g)\") +\n  scale_y_continuous(expand=expansion(mult=c(0,0.05))) +\n  facet_wrap(vars(Location3)) +\n  theme_bw() +\n  theme(axis.title.y=element_blank(),\n        axis.text.y=element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/examine-normality-1-1.png){fig-align='center' width=480}\n:::\n:::\n\n\nAlternatively, Q-Q plots^[I assume the reader is familiar with a Q_Q plot. If not, [this](https://www.statology.org/q-q-plot-normality/) is one resource that may be useful.] may be used to examine normality.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=dat2,mapping=aes(sample=Nest.Weight)) +\n  geom_qq() +\n  geom_qq_line(linewidth=0.75) +\n  scale_x_continuous(name=\"Nest Weight (g)\") +\n  scale_y_continuous(expand=expansion(mult=c(0,0.05))) +\n  facet_wrap(vars(Location3)) +\n  theme_bw() +\n  theme(axis.title.y=element_blank(),\n        axis.text.y=element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/examine-normality-2-1.png){fig-align='center' width=480}\n:::\n:::\n\n\nWith either plot, the data do not appear to follow a normal distribution but, given the sample size, they do not look terribly non-normal either.\n\n@vasquezetal_2022 examined homogeneity of variances with the Bartlett test. I prefer to use Levene's test for this purpose as it does not assume a normal distribution. Both `bartlett.test()` and `leveneTest()` (from `car`) require a formula of the form `response~explanatory`^[Or `dependent~independent`.] as the first argument and the corresponding data frame in `data=`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbartlett.test(Nest.Weight~Location3,data=dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  \n#R|  \tBartlett test of homogeneity of variances\n#R|  \n#R|  data:  Nest.Weight by Location3\n#R|  Bartlett's K-squared = 10.009, df = 3, p-value = 0.01849\n```\n:::\n\n```{.r .cell-code}\ncar::leveneTest(Nest.Weight~Location3,data=dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Levene's Test for Homogeneity of Variance (center = median)\n#R|        Df F value Pr(>F)\n#R|  group  3  2.2121 0.1012\n#R|        41\n```\n:::\n:::\n\n\nUnfortunately, the two results give different answers, with Bartlett's test suggesting unequal variances and Levene's test suggesting the opposite.\n\nGiven these results it may have been appropriate to analyze these data with a one-way ANOVA. I suspect, however, that other variables in the data set more egregiously violated these assumptions and the authors wanted to use consistent methods for all variables. And, of course, using the Kruskal-Wallis test here *a priori* would not be incorrect, though there is some loss of power.\n\n## Kruskal-Wallis Test\nThe Kruskal-Wallis test may be performed with `kruskal.test()` using the same arguments as `bartlett.test()` or `leveneTest()` above.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nkruskal.test(Nest.Weight~Location3,data=dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  \n#R|  \tKruskal-Wallis rank sum test\n#R|  \n#R|  data:  Nest.Weight by Location3\n#R|  Kruskal-Wallis chi-squared = 11.571, df = 3, p-value = 0.009006\n```\n:::\n:::\n\n\nThis result provides strong evidence that the **median** total nest weight is different for at least one of the area types.\n\n## Post-hoc Multiple Comparisons\nDunn's test^[I assume that the reader is familiar with Dunn's Test. If not [this](https://www.statology.org/dunns-test/) is one resources that may be helpful.] may be used, after a significant Kruskal-Wallis test, to determine which pairs of **medians** differ after adjusting for multiple comparisons. Dunn's test is performed with `dunnTest()` from `FSA` using the same arguments as given to `kruskal.test()` above. As noted in the results below, `dunnTest()` defaults to using the \"Holm\" method to adjust for multiple comparisons. Other methods may be used with `method=`.^[See the possible methods with `?dunn.test::dunn.test`.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nFSA::dunnTest(Nest.Weight~Location3,data=dat2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|             Comparison        Z     P.unadj      P.adj\n#R|  1 Parks - Residential 0.233670 0.815241172 0.81524117\n#R|  2       Parks - Rural 1.007831 0.313535451 0.62707090\n#R|  3 Residential - Rural 1.042160 0.297337581 0.89201274\n#R|  4       Parks - Urban 2.751550 0.005931397 0.02965699\n#R|  5 Residential - Urban 3.126111 0.001771347 0.01062808\n#R|  6       Rural - Urban 2.542487 0.011006664 0.04402666\n```\n:::\n:::\n\n\nFrom these results it is apparent that the **median** nest weight in the \"Urban\" areas differs from the other three area types, which all have statistically equal medians.\n\n&nbsp;\n\n# Displaying Results\n## Create Summary Data Frame\nThe Kruskal-Wallis test is a test of the equality of **medians** across groups. Thus, in my opinion, a summary graphic for this test should plot the medians with their respective confidence intervals. Computing the confidence intervals for medians across groups takes a bit of work in R. This process is described below.\n\nThe original data frame is converted to a list with separate vectors of nest weights for each area type.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntmp <- split(dat2$Nest.Weight,dat2$Location3)\ntmp\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  $Rural\n#R|   [1] 45.7 52.6 32.2 61.5 93.9 22.2 54.2 40.9 63.1 47.1 19.2 52.2 39.1 82.8 50.8\n#R|  [16] 25.6 58.5 38.8 23.8 85.4 23.8\n#R|  \n#R|  $Parks\n#R|  [1] 38.7 54.2 87.9 55.1 45.7\n#R|  \n#R|  $Residential\n#R|   [1] 44.1 69.1 37.1 47.0 70.4 51.7 79.2 53.8 44.4 65.8 44.7 43.7\n#R|  \n#R|  $Urban\n#R|  [1] 27.5 31.8 35.4 35.6 18.5 32.2 27.5\n```\n:::\n:::\n\n\n`MedianCI()` from `DescTools` may be used to compute the median and corresponding confidence interval for a vector of values. Below is an example for the \"Urban\" area. The default is to use a so-called \"exact\" method, but here I prefer to use \"bootstrapping\" instead so I include `method=\"boot\"`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nDescTools::MedianCI(tmp$Urban,method=\"boot\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  median lwr.ci upr.ci \n#R|    31.8   28.2   36.1\n```\n:::\n:::\n\n\n`sapply()` can be used to \"apply\" `MedianCI()` to each item in the `tmp` list (so each area type) and return the result as a matrix.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntmp <- sapply(tmp,FUN=DescTools::MedianCI,method=\"boot\")\ntmp\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|         Rural Parks Residential Urban\n#R|  median  47.1  54.2       49.35  31.8\n#R|  lwr.ci  40.0  20.5       31.25  28.2\n#R|  upr.ci  55.4  69.7       54.45  36.1\n```\n:::\n:::\n\n\nHowever, the \"median\", \"lwr.ci\", and \"upper.ci\" should be the columns rather than the rows of this matrix. Thus, `t()` is used below to \"transpose\" the matrix which is then given to `data.frame()` to convert the matrix to a data frame.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsumNW <- t(tmp) |>\n  data.frame()\nsumNW\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|              median lwr.ci upr.ci\n#R|  Rural        47.10  40.00  55.40\n#R|  Parks        54.20  20.50  69.70\n#R|  Residential  49.35  31.25  54.45\n#R|  Urban        31.80  28.20  36.10\n```\n:::\n:::\n\n\nNow, unfortunately, the area type names are row names and not a variable. Below, these row names are used to create a new `Location3` variable and then converted to a factor with the levels controlled to match the authors' order along a rural to urban gradient.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsumNW <- sumNW |>\n  mutate(Location3=rownames(sumNW),\n         Location3=factor(Location3,levels=c(\"Rural\",\"Parks\",\"Residential\",\"Urban\")))\nsumNW\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|              median lwr.ci upr.ci   Location3\n#R|  Rural        47.10  40.00  55.40       Rural\n#R|  Parks        54.20  20.50  69.70       Parks\n#R|  Residential  49.35  31.25  54.45 Residential\n#R|  Urban        31.80  28.20  36.10       Urban\n```\n:::\n:::\n\n\nFinally, a new variable is added that contains \"significance letters\" that communicate the results from Dunn's Test above. Groups that have the same letter are statistically equal and those with different letters are statistically not equal. In this case, \"Urban\" was different than the other three which were all the same. Thus, \"Urban\" will have a unique letter that is different then the same letter used for the other three. I usually start the letters on the left, so \"Rural\" gets an \"a\" which it will share with \"Parks\" and \"Residential\" before \"Urban\" gets a \"b.\"\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsumNW <- sumNW |>\n  mutate(letsH=c(\"a\",\"a\",\"a\",\"b\"))\nsumNW\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|              median lwr.ci upr.ci   Location3 letsH\n#R|  Rural        47.10  40.00  55.40       Rural     a\n#R|  Parks        54.20  20.50  69.70       Parks     a\n#R|  Residential  49.35  31.25  54.45 Residential     a\n#R|  Urban        31.80  28.20  36.10       Urban     b\n```\n:::\n:::\n\n\nThis data frame is the used to construct the summary graphic below.\n\n## Summary Graphic\nI created the summary graphic below by ...\n\n- Mapping `Location3` to the x-axis for all geoms.\n- Mapping `lwr.ci` and `upr.ci` to `ymin=` and `ymax=`, respectively, in `geom_errobar()` to create the \"intervals.\" Here `linewidth=` was increased to make the interval lines \"heavier\"^[The use of `linewidth=` was discussed in more detail in [this post](../2023-4-4_Size/).] and `width=` was reduced to make the \"caps\" at the end of the interval lines narrower.\n- Mapping `median` to `y=` in `geom_point()` to place a point at the median. `geom_point()` came afer `geom_errorbar()` so that the point would be \"on top\" of the interval line. Here an open circle was used for the point with an inner portion a light gray and a black outline. The point was made larger than the default, as was the \"stroke\" used to draw the outline.^[The use of `size=` and `stroke=` was discussed in more detail in [this post](../2023-4-4_Size/).]\n- Mapping `letsH` to `labels=` and `upr.ci=` to `y` in `geom_text()` to place the significance letters at the upper CI value. The `vjust=` was used to move the text up slightly^[The use of `vjust=` was discussed in more detail in [this post](../2023-3-10-Text_Annotation_Position/).] and `size=` was used to show the letters in a 12 pt font.^[The use of `size=` was discussed in more detail in [this post](../2023-4-4_Size/).]\n- The y-axis was labeled, the breaks were controlled at 10 g intervals, the lower limit was constrained to be at 0, and the lower expansion was removed so that the x-axis was shown at a y of 0.\n- The x-axis was labeled.\n- The black-and-white theme was applied.\n- The axis titles were set a 14 pt font, and the axis tick mark labels were set to be black and in a 12 pt font.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=sumNW,mapping=aes(x=Location3)) +\n  geom_errorbar(mapping=aes(ymin=lwr.ci,ymax=upr.ci),\n                linewidth=0.75,width=0.1) +\n  geom_point(mapping=aes(y=median),\n             shape=21,size=2.5,stroke=1,\n             fill=\"gray70\",color=\"black\") +\n  geom_text(mapping=aes(label=letsH,y=upr.ci),vjust=-0.5,size=12/.pt) +\n  scale_y_continuous(name=\"Median Nest Weight (g)\",\n                     breaks=scales::breaks_width(10),\n                     limits=c(0,NA),expand=expansion(mult=c(0,0.05))) +\n  scale_x_discrete(name=\"Area Type\") +\n  theme_bw() +\n  theme(panel.grid=element_blank(),\n        axis.title=element_text(size=14),\n        axis.text=element_text(size=12,color=\"black\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/make-figure-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}