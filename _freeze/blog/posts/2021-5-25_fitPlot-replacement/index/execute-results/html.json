{
  "hash": "57f2e1b09a5dd5dffbdd170bc1640b69",
  "result": {
    "markdown": "---\ntitle: Replace fitPlot() with ggplot\ndescription: Using `ggplot()` as an alternative to `fitPlot()` which was removed from `FSA`.\nauthor: Derek H. Ogle\ndate: 5/25/2021\nimage: preview.png\ncategories:\n  - FSA\n  - ggplot2\n  - emmeans\n---\n\n\n\n\n:::{.callout-note}\nThe following packages are loaded for use below. I also set the default `ggplot` theme to `theme_bw()` for a classic \"black-and-white\" plot (rather than the default plot with a gray background).\n:::\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(FSA)         ## for peek()\nlibrary(emmeans)     ## for emmeans()\nlibrary(dplyr)       ## for mutate(), select(), filter(), group_by(), summarize()\nlibrary(ggplot2)\ntheme_set(theme_bw())\n```\n:::\n\n\n:::{.callout-warning}\nSome functions illustrated below were in the `FSA` package but have now been removed and put into the non-released `FSAmisc` package that I maintain. These functions are used below **only** to show what could be done in older versions of `FSA` but should now be done as described in this post. **DO NOT USE any of the functions below that begin with `FSAmisc::`.** \n:::\n\n&nbsp;\n\n# Introduction\nWe deprecated `fitPlot()` from FSA v0.9.0 and fully removed it by the start of 2022. We took this action to make `FSA` more focused on fisheries applications and to eliminate \"black box\" functions. `fitPlot()` was originally designed for students to quickly visualize the results of one- and two-way ANOVAs and simple, indicator variable, and logistic regressions.^[Over time functionality for non-linear regressions was added.] We now feel that students are better served by learning how to create these visualizations using methods provided by `ggplot2`, which require more code, but are more modern, flexible, and transparent.\n\nThe basic plots produced by `fitPlot()` are recreated here using `ggplot2` to provide a resource to help users that relied on `fitPlot()` transition to `ggplot2`.\n\n&nbsp;\n\n# Example Data\nExamples below use the `Mirex` data set from `FSA`, which contains the concentration of mirex in the tissue and the body weight of two species of salmon (`chinook` and `coho`) captured in six years. The `year` variable is converted to a factor for modeling purposes and a new variable is created that indicates if the mirex concentration was greater that 0.2 or not. This new variable is used to demonstrate a logistic regression.^[`peek()` from `FSA` is used to examine a portion of the data from evenly-spaced row.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndata(Mirex,package=\"FSA\")\nMirex <- Mirex |>\n  mutate(year=factor(year),\n         gt2=ifelse(mirex>0.2,1,0))\npeek(Mirex,n=10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      year weight mirex species gt2\n#R|  1   1977   0.41  0.16 chinook   0\n#R|  14  1977   3.29  0.23    coho   1\n#R|  27  1982   0.70  0.10    coho   0\n#R|  41  1982   5.09  0.27    coho   1\n#R|  54  1986   1.82  0.12 chinook   0\n#R|  68  1986   8.40  0.13 chinook   0\n#R|  81  1992  10.00  0.48 chinook   1\n#R|  95  1996   5.70  0.16    coho   0\n#R|  108 1999   5.11  0.11    coho   0\n#R|  122 1999  11.82  0.09 chinook   0\n```\n:::\n:::\n\n\n&nbsp;\n\n# One-Way ANOVA\nThe code below fits a one-way ANOVA model to examine if mean weight differs by species.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naov1 <- lm(weight~species,data=Mirex)\nanova(aov1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: weight\n#R|             Df Sum Sq Mean Sq F value    Pr(>F)    \n#R|  species     1  282.4 282.399  27.657 6.404e-07 ***\n#R|  Residuals 120 1225.3  10.211                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\nThere are at least two simple ways to visualize results from a one-way ANOVA. First, *summarized* means of raw data with 95% confidence intervals derived from the standard error, sample size, and degrees-of-freedom specific to each group are shown. These are computed below.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nsumdata <- Mirex |>\n  group_by(species) |>\n  summarize(n=n(),\n            mn=mean(weight),\n            se=se(weight)) |>\n  mutate(lci=mn-qt(0.975,df=n-1)*se,\n         uci=mn+qt(0.975,df=n-1)*se)\nsumdata\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  # A tibble: 2 Ã— 6\n#R|    species     n    mn    se   lci   uci\n#R|    <fct>   <int> <dbl> <dbl> <dbl> <dbl>\n#R|  1 chinook    67  6.31 0.474  5.37  7.26\n#R|  2 coho       55  3.26 0.279  2.70  3.82\n```\n:::\n:::\n\n\n&nbsp;\n\nSecond, marginal means may be predicted or estimated from the fitted model.^[These are discussed in detail in [this vignette](https://cran.r-project.org/web/packages/emmeans/vignettes/basics.html) from the `emmeans` package.] The main difference from above is that confidence intervals for the marginal means use an \"overall\" standard deviation and degrees-of-freedom estimated from across all groups. The estimated marginal means may be computed with with `emmeans()` from `emmeans`.^[They may also be computed with `predict(aov1,newdata=data.frame(species=c(\"chinook\",\"coho\")),interval=\"confidence\").`]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naov1mc <- emmeans::emmeans(aov1,specs=pairwise~species)\naov1mcs <- summary(aov1mc)\naov1mcs$emmeans\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|   species emmean    SE  df lower.CL upper.CL\n#R|   chinook   6.31 0.390 120     5.54     7.09\n#R|   coho      3.26 0.431 120     2.40     4.11\n#R|  \n#R|  Confidence level used: 0.95\n```\n:::\n:::\n\n\n&nbsp;\n\n`fitPlot()` from `FSA` used the summarized means with 95% confidence intervals for both species.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::fitPlot(aov1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_1way_A-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n \n### Using Manually Summarized Means\nThe summarized means saved in `sumdata` above can be plotted as shown below to recreate the `fitPlot()` result. `width=0.1` in `geom_errorbar()` is used to reduce the width of the \"caps\" at the confidence values and `group=1` is needed in `geom_line()` as there is only one point for each factor level. Changes (themes, colors, labels, etc) to this basic plot can be made as usual for `ggplot()`s (and is illustrated further below).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=sumdata,mapping=aes(x=species)) +\n  geom_errorbar(mapping=aes(ymin=lci,ymax=uci),width=0.1) +\n  geom_line(mapping=aes(y=mn,group=1)) +\n  geom_point(mapping=aes(y=mn))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_1way_B-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Built-In Functions for Summarized Means\nThis plot can also be constructed without having previously summarized the group means by using `stat_summary()` coupled with `mean_cl_normal()` and `mean()`. Below note how each `geom=` in each `stat_summary()` mirrors what was used above. Also note the use of `width=0.1` and `group=1` here as done above.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=Mirex,mapping=aes(x=species,y=weight)) +  \n  stat_summary(fun.data=mean_cl_normal,geom=\"errorbar\",width=0.1) +  \n  stat_summary(fun=mean,geom=\"line\",mapping=aes(group=1)) +  \n  stat_summary(fun=mean,geom=\"point\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_1way_C-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Marginal Means from `emmeans`\nThe estimated marginal means may be plotted similarly to the manually summarized means. However, the `aov1mcs$emmeans` data frame created above is used, which also requires using `lower.CL` and `upper.CL` for the `ymin=` and `ymax=` in `geom_errorbar()` and `emmean` for the `y=` mean value in `geom_line()` and `geom_point()`.^[Review the output from `aov1mcs$emmeans` above taking special note of the variable names.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=aov1mcs$emmeans,mapping=aes(x=species)) +\n  geom_errorbar(mapping=aes(ymin=lower.CL,ymax=upper.CL),width=0.1) +\n  geom_line(mapping=aes(y=emmean,group=1)) +\n  geom_point(mapping=aes(y=emmean))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_1way_D-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n# Two-Way ANOVA\nThe code below fits a two-way ANOVA model to examine if mean weight differs by species, by year, or by the interaction between species and year.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naov2 <- lm(weight~year*species,data=Mirex)\nanova(aov2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: weight\n#R|                Df Sum Sq Mean Sq F value    Pr(>F)    \n#R|  year           5 281.86  56.373  6.9954 1.039e-05 ***\n#R|  species        1 221.69 221.689 27.5099 7.648e-07 ***\n#R|  year:species   5 117.69  23.538  2.9208   0.01628 *  \n#R|  Residuals    110 886.44   8.059                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\n\n`fitPlot()` from `FSA` used the mean with 95% confidence interval for all combinations of species and year.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::fitPlot(aov2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_2way_A-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Built-In Functions for Summarized Means \nAgain, `stat_summary()` can be used to efficiently calculate and then plot the 95% confidence intervals and means similar to what was shown above for a one-way ANOVA. However, there are three major differences.\n\nFirst, in the main `ggplot()` call the color of the points and lines is mapped to one of the two factor variables (`species` in this case) whereas the other factor variable is mapped to `x=`.^[These two variables can, of course, be exchanged. However, I generally prefer to have the variable with more levels on the x-axis.] Second, the `group=` aesthetic for the line geom must be set to the factor that describes how the lines should be connected, which will be the same as the variable mapped to the color aesthetic (e.g., `species` in this case). Third, the intervals and (possibly) the points at each level on the x-axis will overlap if they are not \"dodged\" a small amount.^[Note this same problem occurs for the `fitPlot()`, though there is no simple solution for it.] The \"dodge\" amount should be set outside the `geom()`s so that each geom uses the same amount of \"dodging.\" This will assure that the intervals, points, and connecting lines for each level defined by the colors align. Below this \"dodge\" amount is set with `position_dodge()` and saved to an object called `pd` which is then set equal to `position=` in each `geom()`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npd <- position_dodge(width=0.2)\nggplot(data=Mirex,mapping=aes(x=year,y=weight,color=species)) +  \n  stat_summary(fun.data=mean_cl_normal,geom=\"errorbar\",width=0.2,position=pd) + \n  stat_summary(fun=mean,geom=\"line\",mapping=aes(group=species),position=pd) +  \n  stat_summary(fun=mean,geom=\"point\",position=pd)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_2way_B-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n&nbsp;\n\n### Using Marginal Means from `emmeans`\nThe mearginal means are again computed with `emmeans()`, but with `year:species` so that the marginal means and confidence intervals are estimated for each combination of `year` and `species`.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\naov2mc <- emmeans::emmeans(aov2,specs=pairwise~year:species)\naov2mcs <- summary(aov2mc)\naov2mcs$emmeans\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|   year species emmean    SE  df lower.CL upper.CL\n#R|   1977 chinook   3.35 0.819 110    1.723     4.97\n#R|   1982 chinook   3.94 0.819 110    2.319     5.57\n#R|   1986 chinook   6.20 0.819 110    4.571     7.82\n#R|   1992 chinook   8.91 1.073 110    6.788    11.04\n#R|   1996 chinook   7.79 0.856 110    6.090     9.48\n#R|   1999 chinook   8.71 0.787 110    7.148    10.27\n#R|   1977 coho      3.06 0.819 110    1.436     4.68\n#R|   1982 coho      3.43 0.819 110    1.808     5.06\n#R|   1986 coho      2.71 0.819 110    1.090     4.34\n#R|   1992 coho      4.60 1.270 110    2.084     7.12\n#R|   1996 coho      2.67 1.004 110    0.681     4.66\n#R|   1999 coho      4.05 1.159 110    1.753     6.35\n#R|  \n#R|  Confidence level used: 0.95\n```\n:::\n:::\n\n\nThe plot of these marginal means is constructed similarly to that for the one-way ANOVA but using the dodging and color aesthetics described above.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npd <- position_dodge(width=0.2)\nggplot(data=aov2mcs$emmeans,mapping=aes(x=year,color=species)) +\n  geom_errorbar(mapping=aes(ymin=lower.CL,ymax=upper.CL),width=0.2,position=pd) +\n  geom_line(mapping=aes(y=emmean,group=species),position=pd) +\n  geom_point(mapping=aes(y=emmean),position=pd)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_2way_C-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n&nbsp;\n\n# Simple Linear Regression\nThe code below fits a simple linear regression for examining the relationship between mirex concentration and salmon weight.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nslr <- lm(mirex~weight,data=Mirex)\nanova(slr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: mirex\n#R|             Df  Sum Sq  Mean Sq F value    Pr(>F)    \n#R|  weight      1 0.22298 0.222980  26.556 1.019e-06 ***\n#R|  Residuals 120 1.00758 0.008396                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\n`fitPlot()` from `FSA` showed the best-fit line with a 95% confidence band.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::fitPlot(slr,interval=\"confidence\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_SLR_A-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Manually Predicted Values I\nOne method for recreating this plot is to create a new data frame that first has the two variables of observed data and then adds on predicted values of the response at each observed value of the explanatory variable with 95% confidence intervals. The two observed variables are selected from the original data frame with `select()`. If this new data frame is given to `newdata=` in `predict()` with `interval=\"confidence\"` then the predicted values (and 95% confidence intervals) will be constructed at each value of the explanatory variable. The two data frames are then column-bound together with `cbind()` to make one data frame for plotting (further below).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nslrdf <- Mirex |>\n  select(weight,mirex)\nslrdf <- cbind(slrdf,predict(slr,newdata=slrdf,interval=\"confidence\"))\npeek(slrdf,n=6)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      weight mirex       fit        lwr       upr\n#R|  1     0.41  0.16 0.1226593 0.09588108 0.1494376\n#R|  24    7.75  0.34 0.2119229 0.19088398 0.2329618\n#R|  49    0.34  0.02 0.1218080 0.09477073 0.1488453\n#R|  73    1.90  0.10 0.1407796 0.11907549 0.1624837\n#R|  98    9.10  0.29 0.2283406 0.20287925 0.2538019\n#R|  122  11.82  0.09 0.2614192 0.22530410 0.2975342\n```\n:::\n:::\n\n\nThe confidence band is first plotted as a \"ribbon\" with the best-fit line then added followed by the observed points. In this plot, `weight` is globally mapped to `x=` in `ggplot()` so that it will be used for each geom. The lower and upper confidence values are mapped to `ymin=` and `ymax=` in `geom_ribbon()`, whereas the predicted or \"fit\"ted values are mapped to `y=` `geom_line()` to make the line and the observed mirex concentrations are mapped to `y=` in `geom_point()` to plot the observed points. Further note the use of `alpha=` to make the confidence band semi-transparent and `size=` to make the fitted line slightly larger than the default. Again all aspects of this plot can be changed in the usual ggplot way.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=slrdf,mapping=aes(x=weight)) +\n  geom_ribbon(mapping=aes(ymin=lwr,ymax=upr),alpha=0.2) +\n  geom_line(mapping=aes(y=fit),size=1) +\n  geom_point(mapping=aes(y=mirex))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_SLR_B-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Manually Predicted Values II\nWith more sparse data sets there may not be enough predicted values to make a smooth plot. In these cases, a separate data frame with more designated values for the explanatory variable is useful. The first line below creates a data frame of weights that consists of 101 evenly spaced values from the minimum to maximum observed weight in the original data frame. Concentrations of mirex at each of these weights are then predicted from the regression line and bound to the data frame.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nnd <- data.frame(weight=seq(min(slrdf$weight),max(slrdf$weight),length.out=101))\nnd <- cbind(nd,predict(slr,newdata=nd,interval=\"confidence\"))\npeek(slrdf,n=6)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      weight mirex       fit        lwr       upr\n#R|  1     0.41  0.16 0.1226593 0.09588108 0.1494376\n#R|  24    7.75  0.34 0.2119229 0.19088398 0.2329618\n#R|  49    0.34  0.02 0.1218080 0.09477073 0.1488453\n#R|  73    1.90  0.10 0.1407796 0.11907549 0.1624837\n#R|  98    9.10  0.29 0.2283406 0.20287925 0.2538019\n#R|  122  11.82  0.09 0.2614192 0.22530410 0.2975342\n```\n:::\n:::\n\n\nThe plot is now constructed from two data frames -- `slrdf` with the original observed data and `nd` with predicted concentrations of mirex at specifically chosen weights. Given this, the data to use must be specifically declared within each geom, with `geom_ribbon()` and `geom_line()` using the predicted data frame (i.e., `nd`) and `geom_point()` using the observed data (i.e., `slrdf`).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot() +\n  geom_ribbon(data=nd,mapping=aes(x=weight,ymin=lwr,ymax=upr),alpha=0.2) +\n  geom_line(data=nd,mapping=aes(x=weight,y=fit),size=1) +\n  geom_point(data=slrdf,mapping=aes(x=weight,y=mirex))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_SLR_C-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using A Built-In Function\nThe best-fit line can also be added to a scatterplot with `geom_smooth()`, where `method=\"lm\"` makes sure that a linear model is used for the \"smoother.\"\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=Mirex,mapping=aes(x=weight,y=mirex)) +\n  geom_smooth(method=\"lm\",alpha=0.2) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_SLR_D-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n# Indicator Variable Regression\nThe code below fits an indicator variable regression to examine if the relationship between mirex concentration and salmon weight differs betwen species.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nivr <- lm(mirex~weight*species,data=Mirex)\nanova(ivr)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  Analysis of Variance Table\n#R|  \n#R|  Response: mirex\n#R|                  Df  Sum Sq  Mean Sq F value    Pr(>F)    \n#R|  weight           1 0.22298 0.222980 26.8586 9.155e-07 ***\n#R|  species          1 0.00050 0.000498  0.0600   0.80690    \n#R|  weight:species   1 0.02744 0.027444  3.3057   0.07158 .  \n#R|  Residuals      118 0.97964 0.008302                      \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n&nbsp;\n\n`fitPlot()` from `FSA` showed the best-fit line for both species.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::fitPlot(ivr,interval=\"confidence\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_IVR_A-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Manually Predicted Values\nThe process of constructing a similar plot in `ggplot()` follows the same general procedure as that for a simple linear regression. First, make a data frame that has the observed variables used in the model and predicted values and confidence limits for each observation.^[Again, one may want to make a data frame with more values of the explanatory variable if the observed data is sparse.]\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nivrdf <- select(Mirex,weight,mirex,species)\nivrdf <- cbind(ivrdf,predict(ivr,newdata=ivrdf,interval=\"confidence\"))\npeek(ivrdf,n=6)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      weight mirex species        fit        lwr       upr\n#R|  1     0.41  0.16 chinook 0.13939054 0.09905499 0.1797261\n#R|  24    7.75  0.34 chinook 0.20990801 0.18638517 0.2334308\n#R|  49    0.34  0.02    coho 0.09192064 0.04956596 0.1342753\n#R|  73    1.90  0.10    coho 0.12580003 0.09660968 0.1549904\n#R|  98    9.10  0.29 chinook 0.22287784 0.19567885 0.2500768\n#R|  122  11.82  0.09 chinook 0.24900965 0.21056798 0.2874513\n```\n:::\n:::\n\n\n&nbsp;\n\nThen plot the data as before but making sure to map `color=` and `fill=` (just for the ribbon) to the species factor variable.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=ivrdf,mapping=aes(x=weight,color=species)) +\n  geom_ribbon(mapping=aes(ymin=lwr,ymax=upr,fill=species),alpha=0.2) +\n  geom_line(mapping=aes(y=fit),size=1) +\n  geom_point(mapping=aes(y=mirex))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_IVR_B-1.png){fig-align='center' width=432}\n:::\n:::\n\n\n&nbsp;\n\n### Using a Built-In Function\nThis plot can also be constructed with `geom_smooth()`, again making sure to map the `color=` and `fill=` to the species factor variable.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=Mirex,mapping=aes(x=weight,y=mirex,color=species,fill=species)) +\n  geom_smooth(method=\"lm\",alpha=0.2) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_IVR_C-1.png){fig-align='center' width=432}\n:::\n:::\n\n\n&nbsp;\n\n# Logistic Regression\nThe code below fits a logistic regression to examine the relationship between the probability that mirex concentration is greater than 0.2 and salmon weight.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlogreg <- glm(gt2~weight,data=Mirex,family=\"binomial\")\nsummary(logreg)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  \n#R|  Call:\n#R|  glm(formula = gt2 ~ weight, family = \"binomial\", data = Mirex)\n#R|  \n#R|  Deviance Residuals: \n#R|      Min       1Q   Median       3Q      Max  \n#R|  -1.7696  -0.7462  -0.5566   0.9537   1.9789  \n#R|  \n#R|  Coefficients:\n#R|              Estimate Std. Error z value Pr(>|z|)    \n#R|  (Intercept) -2.19359    0.41871  -5.239 1.61e-07 ***\n#R|  weight       0.29822    0.06496   4.591 4.41e-06 ***\n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#R|  \n#R|  (Dispersion parameter for binomial family taken to be 1)\n#R|  \n#R|      Null deviance: 158.35  on 121  degrees of freedom\n#R|  Residual deviance: 132.32  on 120  degrees of freedom\n#R|  AIC: 136.32\n#R|  \n#R|  Number of Fisher Scoring iterations: 3\n```\n:::\n:::\n\n\n&nbsp;\n\n`fitPlot()` from `FSA` showed the fitted logistic regression curve with the observed values transparently at the top and bottom of the y-axis and symbols at the proportion of \"successes\" for \"windows\" of the x-axis.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::fitPlot(logreg)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_LogReg_A-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Manually Predicted Values\nThe first method for showing the logistic regression curve follows the general methodology for simple linear regression shown above. Note, however, that `predict()` does not produce confidence interval values for a logistic regression. Thus, the plot created in this way cannot have a confidence band.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlogregdf <- select(Mirex,gt2,weight)\nlogregdf$fit <- predict(logreg,newdata=logregdf,\n                        type=\"response\",interval=\"confidence\")\npeek(logregdf,n=6)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|      gt2 weight       fit\n#R|  1     0   0.41 0.1119161\n#R|  24    1   7.75 0.5293765\n#R|  49    0   0.34 0.1098580\n#R|  73    0   1.90 0.1642466\n#R|  98    1   9.10 0.6272046\n#R|  122   0  11.82 0.7910738\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=logregdf,mapping=aes(x=weight)) +\n  geom_point(mapping=aes(y=gt2),alpha=0.25) +\n  geom_line(mapping=aes(y=fit),size=1)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_LogReg_B-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using a Built-In Function\nThe best-fit logistic regression curve with a confidence band can, however, be added to a scatterplot with `geom_smooth()`. In this case, `method=` must be changed to `glm` and `method.args=` must be used as shown below so that `glm` will construct a logistic (rather than linear) regression.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=Mirex,mapping=aes(x=weight,y=gt2)) +\n  geom_smooth(method=\"glm\",alpha=0.2,method.args=list(family=\"binomial\")) +\n  geom_point(alpha=0.25)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_LogReg_C-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\nNote that this method easily generalizes to an indicator variable logistic regression (note that `color=` and `fill=` are mapped to the species factor variable).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlogreg2 <- glm(gt2~weight*species,data=Mirex,family=\"binomial\")\n\nggplot(data=Mirex,mapping=aes(x=weight,y=gt2,color=species,fill=species)) +\n  geom_smooth(method=\"glm\",alpha=0.2,\n              method.args=list(family=\"binomial\")) +\n  geom_point(alpha=0.25)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_LogReg_D-1.png){fig-align='center' width=432}\n:::\n:::\n\n\n&nbsp;\n\n# Polynomial Regression\nThe code below fits a quadratic (second degree polynomial) regression for the relationship between mirex concentration and salmon weight.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npoly2 <- lm(mirex~weight+I(weight^2),data=Mirex)\nsummary(poly2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.output}\n#R|  \n#R|  Call:\n#R|  lm(formula = mirex ~ weight + I(weight^2), data = Mirex)\n#R|  \n#R|  Residuals:\n#R|        Min        1Q    Median        3Q       Max \n#R|  -0.208068 -0.048257  0.000994  0.060883  0.244424 \n#R|  \n#R|  Coefficients:\n#R|                Estimate Std. Error t value Pr(>|t|)    \n#R|  (Intercept)  0.0875361  0.0209754   4.173 5.74e-05 ***\n#R|  weight       0.0283282  0.0086331   3.281  0.00136 ** \n#R|  I(weight^2) -0.0013524  0.0006953  -1.945  0.05413 .  \n#R|  ---\n#R|  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#R|  \n#R|  Residual standard error: 0.09059 on 119 degrees of freedom\n#R|  Multiple R-squared:  0.2064,\tAdjusted R-squared:  0.1931 \n#R|  F-statistic: 15.48 on 2 and 119 DF,  p-value: 1.06e-06\n```\n:::\n:::\n\n\n&nbsp;\n\n`fitPlot()` from `FSA` showed the best-fit regression curve.\n\n\n::: {.cell layout-align=\"center\" par1='true'}\n\n```{.r .cell-code}\nFSAmisc::fitPlot(poly2,interval=\"confidence\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_poly_A-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using Manually Predicted Values\nThis regression can be viewed similarly to the way the simple linear regressions was viewed.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npolydf <- select(Mirex,weight,mirex)\npolydf <- cbind(polydf,predict(poly2,newdata=polydf,interval=\"confidence\"))\nggplot(polydf,mapping=aes(x=weight)) +\n  geom_ribbon(mapping=aes(ymin=lwr,ymax=upr),alpha=0.2) +\n  geom_line(mapping=aes(y=fit),size=1) +\n  geom_point(mapping=aes(y=mirex))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_poly_B-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n### Using a Built-In Function\nThis type of regression can also be viewed using `geom_smooth()` but the formula for the polynomial must be given to `formula=`. However, note that in this formula you put `y` and `x` rather than the names of the variables that are mapped to `y` and `x`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=Mirex,mapping=aes(x=weight,y=mirex)) +\n  geom_smooth(method=\"lm\",formula=\"y~x+I(x^2)\",alpha=0.2) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_poly_C-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n# Nonlinear Regression\nThe concepts about producing a fitted line plot for a non-linear regression in `ggplot` is described in detail, with respect to a von Bertalanffy growth function, in [this post](../2019-12-31_vonB_plots_1/) and [this post](../2020-1-2_vonB_plots_2/).\n\n&nbsp;\n\n# Conclusion\n`fitPlot()` in `FSA` was removed in early 2022. This post describes a more transparent (i.e., not a \"black box\") and flexible set of methods for constructing similar plots using `ggplot2` for those who will need to transition away from using `fitPlot()`.\n\nAs mentioned in the examples above, each plot can be modified further using typical methods for `ggplot2`. These changes were not illustrated above to minimize the amount of code shown in this post. However, as an example, the code below shows a possible modification of the IVR plot shown above.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(data=Mirex,mapping=aes(x=weight,y=mirex,color=species,fill=species)) +\n  geom_smooth(method=\"lm\",alpha=0.1,size=1.25) +\n  geom_point(size=1.5) +\n  scale_y_continuous(name=\"Mirex Concentration in Tissue\",limits=c(0,0.5),\n                     expand=expansion(mult=0)) +\n  scale_x_continuous(name=\"Salmon Weight (kg)\",limits=c(0,15),\n                     expand=expansion(mult=0)) +\n  scale_color_manual(values=c(\"#E69F00\",\"#0072B2\"),\n                     aesthetics=c(\"color\",\"fill\")) +\n  theme(panel.grid.major=element_line(color=\"gray90\",linetype=\"dashed\"),\n        panel.grid.minor=element_blank(),\n        axis.title=element_text(size=rel(1.25)),\n        axis.text=element_text(size=rel(1.1)),\n        legend.position=c(0,1),\n        legend.justification=c(-0.05,1.02),\n        legend.title=element_blank(),\n        legend.text=element_text(size=rel(1.1)))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fitPlot_Final-1.png){fig-align='center' width=336}\n:::\n:::\n\n\n&nbsp;\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}